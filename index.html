<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>立座表＋月間シフト（Firestore版）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Firebase v8（global 名前空間で firebase.firestore() を使う） -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script>
    // TODO: 自分の Firebase プロジェクトの設定に差し替え
    var firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    window.db = firebase.firestore();
  </script>

  <style>
    body {
      margin: 8px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-size: 14px;
      color: #333;
      box-sizing: border-box;
    }
    *, *::before, *::after { box-sizing: inherit; }

    h1 {
      font-size: 20px;
      margin: 4px 0 8px;
    }

    .top-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 16px;
      align-items: center;
      margin-bottom: 8px;
    }
    .top-controls label {
      font-size: 14px;
      white-space: nowrap;
    }
    #currentTime {
      font-weight: bold;
      color: #d35400;
    }

    .days-container {
      margin-top: 8px;
    }

    .day-wrapper {
      display: none;
      margin-bottom: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 4px;
      background: #fafafa;
    }
    .day-wrapper.active {
      display: block;
    }

    .day-title {
      font-weight: bold;
      margin-bottom: 4px;
      font-size: 15px;
    }

    .day-inner {
      display: flex;
      align-items: stretch;
      gap: 4px;
    }

    .place-container {
      flex: 0 0 150px;
    }
    .table-container {
      flex: 1 1 auto;
      overflow-x: auto;
      overflow-y: hidden;
      border-left: 1px solid #ddd;
    }

    table {
      border-collapse: collapse;
      border-spacing: 0;
      font-size: 12px;
      table-layout: fixed;
    }

    .place-table th,
    .place-table td,
    .schedule-table th,
    .schedule-table td {
      border: 1px solid #ddd;
      padding: 2px 4px;
      text-align: center;
      white-space: nowrap;
    }

    .place-table {
      width: 100%;
    }

    .place-cell {
      background: #f5f5f5;
      font-weight: 600;
      font-size: 12px;
    }

    .schedule-table {
      min-width: 1200px;
    }

    .schedule-table thead th {
      background: #f0f0f0;
      position: sticky;
      top: 0;
      z-index: 2;
      font-weight: 500;
    }

    .slot-cell {
      background: #fff;
    }
    .slot-cell.empty {
      background: #fff;
    }

    /* 状態ごとの色（お好みで調整してOK） */
    .state-本 { background: #e3f2fd; }
    .state-立 { background: #ffe0b2; }
    .state-座 { background: #fff9c4; }
    .state-巡 { background: #e8f5e9; }
    .state-東 { background: #f3e5f5; }
    .state-仮眠 { background: #ffe4e1; }
    .state-休 { background: #eeeeee; color: #555; }
    .state-掃 { background: #d7ccc8; }
    .state-待 { background: #f0f4c3; }
    .state-準 { background: #c5cae9; }
    .state-ロ↑,
    .state-ロ↓ {
      background: #ffecb3;
      font-weight: bold;
      color: #d35400;
    }

    /* 現在時刻のスロット */
    .now-col {
      outline: 2px solid #ff9800;
      outline-offset: -1px;
      background: #fff3e0 !important;
    }

    /* 名前入力パネル */
    .names-panel {
      display: none;
      margin-top: 6px;
      padding: 4px;
      border-radius: 4px;
      border: 1px dashed #ccc;
      background: #fcfcfc;
    }
    .names-panel.active {
      display: block;
    }
    .name-line {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 4px;
    }
    .name-line-label {
      width: 100px;
      font-size: 12px;
      color: #555;
      flex-shrink: 0;
    }
    .name-line input {
      flex: 1 1 auto;
      min-width: 0;
      padding: 2px 4px;
      font-size: 12px;
    }

    /* 月間シフトテーブル */
    .month-shift-container {
      margin-top: 16px;
      padding-top: 8px;
      border-top: 1px solid #ddd;
    }

    .month-shift-header-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 4px;
      flex-wrap: wrap;
    }

    .month-shift-header-row label {
      font-size: 14px;
    }

    .month-shift-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .month-shift-buttons button {
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
    }

    .month-shift-table {
      width: 100%;
      margin-top: 4px;
    }

    .month-shift-table th,
    .month-shift-table td {
      border: 1px solid #ddd;
      padding: 2px 4px;
      font-size: 11px;
      text-align: center;
    }

    .month-shift-name {
      width: 120px;
      min-width: 100px;
      background: #fafafa;
    }
    .month-shift-name input {
      width: 100%;
      border: none;
      background: transparent;
      padding: 2px 4px;
      font-size: 12px;
    }
    .month-shift-name input:focus {
      outline: 1px solid #42a5f5;
      background: #fff;
    }

    .month-shift-table select {
      width: 100%;
      font-size: 11px;
      padding: 1px 2px;
    }

    /* ロータリーメニュー */
    .rotary-menu {
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 1000;
      min-width: 220px;
      font-size: 12px;
    }
    .rotary-menu-title {
      font-weight: bold;
      margin-bottom: 4px;
      font-size: 12px;
    }
    .rotary-menu select {
      width: 100%;
      font-size: 12px;
      padding: 2px 4px;
    }

    /* 編集モードの見た目（ロータリー設定できる場所を分かりやすく） */
    body.month-editing table.place-table[data-day="sat"] .place-cell,
    body.month-editing table.place-table[data-day="sun"] .place-cell {
      cursor: pointer;
      background: #fff3e0;
    }
    body.month-editing table.place-table[data-day="sat"] .place-cell:hover,
    body.month-editing table.place-table[data-day="sun"] .place-cell:hover {
      background: #ffe0b2;
    }
  </style>
</head>
<body>

  <h1>立座表（Firestore共有版）</h1>

  <div class="top-controls">
    <label>
      表示日：
      <select id="daySelect"></select>
    </label>

    <span id="currentTime">現在時刻 --:--</span>

    <label>
      <input type="checkbox" id="editToggle">
      月間シフト編集モード（ロータリー設定ON）
    </label>
  </div>

  <!-- 各日の立座表 -->
  <div class="days-container">

    <!-- 金曜日 -->
    <div class="day-wrapper active" data-day="fri">
      <div class="day-title">金曜日</div>
      <div class="day-inner">
        <div class="place-container">
          <table class="place-table" data-day="fri">
            <tbody>
              <!-- JS で行が生成される -->
            </tbody>
          </table>
        </div>
        <div class="table-container">
          <table class="schedule-table" data-day="fri">
            <thead>
              <tr>
                <!-- JSで時間ヘッダ生成 -->
              </tr>
            </thead>
            <tbody>
              <!-- JS でセルが生成される -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 土曜日 -->
    <div class="day-wrapper" data-day="sat">
      <div class="day-title">土曜日（8:00〜翌10:00）</div>
      <div class="day-inner">
        <div class="place-container">
          <table class="place-table" data-day="sat">
            <tbody>
              <!-- JS で行が生成される -->
            </tbody>
          </table>
        </div>
        <div class="table-container">
          <table class="schedule-table" data-day="sat">
            <thead>
              <tr>
                <!-- JSで時間ヘッダ生成 -->
              </tr>
            </thead>
            <tbody>
              <!-- JS でセルが生成される -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 日曜日 -->
    <div class="day-wrapper" data-day="sun">
      <div class="day-title">日曜日（8:00〜）</div>
      <div class="day-inner">
        <div class="place-container">
          <table class="place-table" data-day="sun">
            <tbody>
              <!-- JS で行が生成される -->
            </tbody>
          </table>
        </div>
        <div class="table-container">
          <table class="schedule-table" data-day="sun">
            <thead>
              <tr>
                <!-- JSで時間ヘッダ生成 -->
              </tr>
            </thead>
            <tbody>
              <!-- JS でセルが生成される -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <!-- 名前入力パネル -->
  <div class="names-panel active" data-day="fri"></div>
  <div class="names-panel" data-day="sat"></div>
  <div class="names-panel" data-day="sun"></div>

  <!-- 月間シフト -->
  <div class="month-shift-container">
    <div class="month-shift-header-row">
      <label>
        対象月：
        <input type="month" id="monthPicker">
      </label>
      <div class="month-shift-buttons">
        <button id="msAddPerson" type="button">行を追加</button>
        <button id="msApplyToSchedule" type="button">保存＆立座表へ反映</button>
      </div>
    </div>
    <table class="month-shift-table">
      <thead>
        <tr id="monthShiftHeadRow">
          <!-- JS で日付ヘッダが入る -->
        </tr>
      </thead>
      <tbody id="monthShiftBody">
        <!-- JS で行が入る -->
      </tbody>
    </table>
  </div>

  <!-- ===================== ここから JS 本体 ===================== -->
  <script>
    // ===== Firestore バックエンド付きの「疑似 localStorage」 =====
    // ブラウザ本体の localStorage / Cookie は一切使わず、
    // 代わりに Firestore の "shiftKV" コレクションに全部保存する。
    const db = window.db || firebase.firestore();
    const __MEM_STORE = {};

    const LS = {
      getItem(key) {
        return Object.prototype.hasOwnProperty.call(__MEM_STORE, key)
          ? __MEM_STORE[key]
          : null;
      },
      setItem(key, value) {
        const v = String(value);
        __MEM_STORE[key] = v;
        if (db) {
          db.collection("shiftKV").doc(key).set({ value: v }).catch(console.error);
        }
      },
      removeItem(key) {
        delete __MEM_STORE[key];
        if (db) {
          db.collection("shiftKV").doc(key).delete().catch(() => {});
        }
      },
      key(index) {
        const keys = Object.keys(__MEM_STORE);
        return keys[index] || null;
      },
      get length() {
        return Object.keys(__MEM_STORE).length;
      }
    };

    // 起動時に Firestore から全キーを読み込んで __MEM_STORE に展開
    async function preloadLSFromFirestore() {
      if (!db) return;
      try {
        const snap = await db.collection("shiftKV").get();
        snap.forEach(doc => {
          const data = doc.data();
          if (data && typeof data.value === "string") {
            __MEM_STORE[doc.id] = data.value;
          }
        });
      } catch (e) {
        console.error("Firestore からの初期読み込みに失敗しました", e);
      }
    }

    (function(){
      const PLACES = [
        "厩舎長",
        "外厩門 1",
        "外厩門 2",
        "外厩門 3",
        "外厩門 4",
        "西通用門 4",
        "西通用門 5",
        "西通用門 6",
        "西通用門 7"
      ];
      const STATES = ["", "本", "立", "座", "巡", "東", "仮眠", "休", "掃", "待", "準", "ロ↑", "ロ↓"];

      const daySelect = document.getElementById("daySelect");
      const editToggle = document.getElementById("editToggle");
      const currentTimeEl = document.getElementById("currentTime");
      const monthPicker = document.getElementById("monthPicker");
      const msAddPerson = document.getElementById("msAddPerson");
      const msApplyButton = document.getElementById("msApplyToSchedule");
      const msHeadRow = document.getElementById("monthShiftHeadRow");
      const msBody = document.getElementById("monthShiftBody");

      // 金曜49、土日など。土曜は 8:00〜翌10:00 で 52 コマ（26時間）
      const SLOT_COUNTS = {
        fri: 49,
        sat: 52,
        sun: 25
      };

      // ===== 土曜・日曜の確定版データ =====
      const INITIAL_DATA = {
        // =========================
        // 金曜日
        // =========================
        fri: {
          "厩舎長": [
            "本","本","待","本","本","本","本","休","休","本","本","本","本","本","本","本","本","本",
            "本","休","休","本","本","本","本","休","本","本","本","仮眠","仮眠","仮眠","仮眠","仮眠","仮眠",
            "仮眠","仮眠","本","本","本","本","本","本","本","本","本","本","本","本"
          ],
          "外厩門 1": [
            "座","立","待","東","東","休","立","座","立","東","東","休","休","座","立","休","休","東",
            "東","座","座","仮眠","仮眠","仮眠","仮眠","仮眠","仮眠","仮眠","仮眠","巡","巡","巡","座","座","座",
            "巡","巡","巡","座","立","座","立","座","立","座","座","立","座","掃"
          ],
          "外厩門 2": [
            "座","座","待","立","座","東","東","休","休","座","立","座","立","東","東","座","立","座",
            "立","休","休","座","座","休","巡","巡","巡","座","座","座","座","座","巡","巡","巡","座",
            "仮眠","仮眠","仮眠","仮眠","仮眠","仮眠","仮眠","座","立","東","東","休","立"
          ],
          "外厩門 3": [
            "立","待","立","座","立","座","休","立","座","休","休","立","座","立","座","東","東","休",
            "休","座","座","東","東","座","座","座","座","巡","巡","仮眠","仮眠","仮眠","仮眠","仮眠","仮眠",
            "仮眠","仮眠","座","座","座","座","立","座","東","東","立","座","立","座"
          ],
          "外厩門 4": [
            "座","待","座","休","休","立","座","東","東","立","座","東","東","休","休","立","座","座",
            "座","東","東","巡","巡","巡","","","","","","","","","","","","","","",
            "","","","","","","","",""
          ],
          "西通用門 4": [
            "","","","","","","","","","","","","","","","","","","","","","","",
            "","座","座","座","座","休","仮眠","仮眠","仮眠","仮眠","仮眠","仮眠","仮眠","仮眠","座","巡","巡",
            "巡","巡","座","立","座","立","掃","休","座"
          ],
          "西通用門 5": [
            "立","待","座","休","休","立","座","本","本","立","座","休","立","座","立","休","休","座",
            "座","座","座","仮眠","仮眠","仮眠","仮眠","仮眠","仮眠","仮眠","仮眠","座","座","座","本","本","本",
            "巡","巡","巡","座","座","座","座","立","座","立","休","座","立","掃"
          ],
          "西通用門 6": [
            "座","立","本","立","座","休","立","座","立","座","立","座","休","休","座","立","座","休",
            "座","座","座","巡","巡","巡","休","座","座","巡","巡","本","本","本","巡","巡","巡","座",
            "座","仮眠","仮眠","仮眠","仮眠","仮眠","仮眠","仮眠","仮眠","待","休","座","立"
          ],
          "西通用門 7": [
            "座","座","立","座","立","座","待","立","座","休","休","立","座","立","待","座","立","座",
            "休","本","本","座","座","座","巡","巡","巡","休","座","巡","巡","巡","座","座","座","本",
            "本","仮眠","仮眠","仮眠","仮眠","仮眠","仮眠","仮眠","仮眠","座","立","休","座"
          ]
        },

        // =========================
        // 土曜日
        // =========================
        sat: {
          "厩舎長": [
            "","","","",
            "本","本","休","本","本","本","本","本","休","休","本","本","本","本","休",
            "本","本","本","休","休","本","本","本","本","休","本","本","本","仮眠","仮眠","仮眠","仮眠",
            "仮眠","仮眠","仮眠","仮眠","本","本","本","本","本","本","本","本","本","待","本","本"
          ],
          "外厩門 1": [
            "","","","",
            "座","休","休","座","立","休","東","東","座","立","休","休","立","座","東",
            "東","休","休","立","座","仮眠","仮眠","仮眠","仮眠","仮眠","仮眠","仮眠","仮眠","巡","巡","巡","座",
            "座","座","巡","巡","座","座","立","座","立","座","立","座","立","座","立","掃"
          ],
          "外厩門 2": [
            "","","","",
            "立","座","立","待","休","休","座","立","休","休","東","東","立","座","座",
            "立","東","東","休","休","座","座","休","座","座","座","巡","巡","座","座","座","巡","巡",
            "巡","座","仮眠","仮眠","仮眠","仮眠","仮眠","仮眠","仮眠","座","立","東","東","座","立"
          ],
          "外厩門 3": [
            "","","","",
            "準","立","座","立","座","立","休","休","立","座","座","休","東","東","休",
            "休","座","立","座","立","東","東","座","巡","巡","巡","休","座","仮眠","仮眠","仮眠","仮眠",
            "仮眠","仮眠","仮眠","座","座","座","座","立","座","立","東","東","座","立","休",""
          ],
          "外厩門 4": [
            "","","","",
            "","","","休","休","座","立","座","東","東","立","座","休","休","立","座",
            "立","座","東","東","巡","巡","巡","巡","巡","巡","座","","","","","","","","",
            "","","","","","","","","","","",""
          ],
          "西通用門 4": [
            "","","","",
            "準","立","座","","","","","","","","","","","","","","",
            "","","","","","座","座","座","座","休","仮眠","仮眠","仮眠","仮眠","仮眠","仮眠","仮眠","仮眠",
            "座","座","座","座","座","座","座","立","座","立","休","掃"
          ],
          "西通用門 5": [
            "","","","",
            "準","座","休","休","立","座","立","座","立","本","休","休","立","座","立",
            "座","休","休","本","座","仮眠","仮眠","仮眠","仮眠","仮眠","仮眠","仮眠","仮眠","本","本","本","巡",
            "巡","巡","座","座","座","座","巡","巡","巡","巡","巡","座","掃","待","立","座"
          ],
          "西通用門 6": [
            "","","","",
            "立","待","本","立","休","休","座","立","座","座","立","座","休","休","座",
            "立","座","立","座","立","座","座","座","休","本","座","座","座","巡","巡","巡","本","本",
            "本","巡","巡","仮眠","仮眠","仮眠","仮眠","仮眠","仮眠","仮眠","仮眠","休","本","座","立"
          ],
          "西通用門 7": [
            "","","","",
            "座","休","立","座","座","立","休","休","本","立","座","立","座","立","休",
            "休","立","座","立","本","巡","巡","巡","座","座","休","巡","巡","座","座","座","座","座",
            "座","本","本","仮眠","仮眠","仮眠","仮眠","仮眠","仮眠","仮眠","仮眠","立","座","待","座"
          ]
        },

        // =========================
        // 日曜日
        // =========================
        sun: {
          "厩舎長": [
            "","","","",
            "本","本","待","本","本","本","休","本","本","本","本","本","本","休","本",
            "本","本","本","本","本","本"
          ],
          "外厩門 1": [
            "","","","",
            "立","座","待","立","座","休","東","東","東","休","座","立","休","座","立",
            "座","座","座","座","座","座"
          ],
          "外厩門 2": [
            "","","","",
            "準","立","座","休","立","座","立","座","立","東","東","休","座","立","休",
            "東","東","座","座","東","東"
          ],
          "外厩門 3": [
            "","","","",
            "座","待","立","座","休","立","座","立","座","立","休","東","東","休","座",
            "立","座","東","東","座","座"
          ],
          "外厩門 4": [
            "","","","",
            "","","","","","","","休","座","立","座","立","東","東","休","",
            "","","","",""
          ],
          "西通用門 4": [
            "","","","",
            "準","立","座","休","立","座","立","座","休","","","","","","","休",
            "座","座","座","座","座"
          ],
          "西通用門 5": [
            "","","","",
            "立","座","立","座","待","立","座","休","立","座","立","座","座","本","立",
            "座","","","","",""
          ],
          "西通用門 6": [
            "","","","",
            "座","待","本","立","座","休","本","立","座","立","座","立","休","座","座",
            "立","","","","",""
          ]
        }
      };

      // 前回のスロット
      let prevSlotIndex = null;

      function getSlotCountForDay(day) {
        const table = document.querySelector(`table.schedule-table[data-day="${day}"]`);
        if (!table) return SLOT_COUNTS[day] || 48;
        const headSlots = table.querySelectorAll("thead th[data-slot]").length;
        return headSlots || (SLOT_COUNTS[day] || 48);
      }

      // thead の時間ヘッダを動的生成
      function buildScheduleHeads() {
        ["fri","sat","sun"].forEach(day => {
          const table = document.querySelector(`table.schedule-table[data-day="${day}"]`);
          if (!table) return;
          const thead = table.querySelector("thead");
          if (!thead) return;
          const tr = thead.querySelector("tr") || thead.appendChild(document.createElement("tr"));
          tr.innerHTML = "";

          const slotCount = SLOT_COUNTS[day] || 48;
          let startMin;
          if (day === "fri") {
            startMin = 9 * 60 + 30;   // 9:30〜
          } else {
            startMin = 8 * 60;        // 土日 8:00〜
          }

          for (let i = 0; i < slotCount; i++) {
            const th = document.createElement("th");
            const minutes = startMin + 30 * i;
            const mmDay = ((minutes % (24 * 60)) + (24 * 60)) % (24 * 60);
            const h = Math.floor(mmDay / 60);
            const m = mmDay % 60;
            const label = `${h}:${m.toString().padStart(2,"0")}`;
            th.textContent = label;
            th.dataset.slot = String(i);
            th.className = "time-head";
            tr.appendChild(th);
          }
        });
      }

      // 場所テーブルのtbody生成
      function buildPlaceTableBodies() {
        ["fri","sat","sun"].forEach(day => {
          const table = document.querySelector(`table.place-table[data-day="${day}"]`);
          if (!table) return;
          const tbody = table.querySelector("tbody");
          tbody.innerHTML = "";
          PLACES.forEach(place => {
            if (day === "sun" && place === "西通用門 7") return;
            const tr = document.createElement("tr");
            tr.dataset.place = place;
            const th = document.createElement("th");
            th.className = "place-cell";
            th.textContent = place;
            tr.appendChild(th);
            tbody.appendChild(tr);
          });
        });
      }

      // スケジュールテーブルのtbody生成
      function buildScheduleBodies() {
        ["fri","sat","sun"].forEach(day => {
          const table = document.querySelector(`table.schedule-table[data-day="${day}"]`);
          if (!table) return;
          const tbody = table.querySelector("tbody");
          tbody.innerHTML = "";
          const slotCount = getSlotCountForDay(day);
          const initForDay = (INITIAL_DATA[day] || {});

          PLACES.forEach(place => {
            if (day === "sun" && place === "西通用門 7") return;
            const tr = document.createElement("tr");
            tr.dataset.place = place;
            const rowInit = initForDay[place] || [];
            for (let i = 0; i < slotCount; i++) {
              const td = document.createElement("td");
              td.dataset.slot = String(i);
              td.className = "slot-cell empty";
              const v = rowInit[i] || "";
              if (v) {
                td.textContent = v;
                applyStateClass(td, v);
              }
              tr.appendChild(td);
            }
            tbody.appendChild(tr);
          });
        });
      }

      // 名前 → 表示文字列
      function buildPlaceDisplay(day, place) {
        let baseLabel;

        if (place === "厩舎長") {
          const key = `name_${day}_${place}_1`;
          const n = LS.getItem(key) || "";
          baseLabel = n ? `${n}（${place}）` : place;
        } else {
          const key1 = `name_${day}_${place}_1`;
          const key2 = `name_${day}_${place}_2`;
          const n1 = LS.getItem(key1) || "";
          const n2 = LS.getItem(key2) || "";
          let namePart = "";
          if (n1 && n2) namePart = `${n1}・${n2}`;
          else if (n1) namePart = n1;
          else if (n2) namePart = n2;
          baseLabel = namePart ? `${namePart}（${place}）` : place;
        }

        // ロータリー情報は表示しない仕様のまま
        return baseLabel;
      }

      function syncPlaceHeaderForDay(day) {
        const table = document.querySelector(`table.place-table[data-day="${day}"]`);
        if (!table) return;
        table.querySelectorAll("tbody tr").forEach(tr => {
          const place = tr.dataset.place;
          if (!place) return;
          const th = tr.querySelector(".place-cell");
          if (!th) return;
          th.textContent = buildPlaceDisplay(day, place);
        });
      }

      function syncAllPlaceHeaders() {
        ["fri","sat","sun"].forEach(syncPlaceHeaderForDay);
      }

      function buildNamePanels() {
        const panels = document.querySelectorAll(".names-panel");
        panels.forEach(panel => {
          const day = panel.dataset.day;
          panel.innerHTML = "";
          PLACES.forEach(place => {
            if (day === "sun" && place === "西通用門 7") return;
            const line = document.createElement("div");
            line.className = "name-line";
            line.dataset.place = place;

            const label = document.createElement("span");
            label.className = "name-line-label";
            label.textContent = place;
            line.appendChild(label);

            const isSingle = (place === "厩舎長");
            if (isSingle) {
              const input = document.createElement("input");
              input.placeholder = "名前";
              const key = `name_${day}_${place}_1`;
              input.value = LS.getItem(key) || "";
              input.addEventListener("input", () => {
                LS.setItem(key, input.value);
                syncPlaceHeaderForDay(day);
                syncRowHeightsForDay(day);
              });
              line.appendChild(input);
            } else {
              const input1 = document.createElement("input");
              input1.placeholder = "名前1";
              const input2 = document.createElement("input");
              input2.placeholder = "名前2";

              const key1 = `name_${day}_${place}_1`;
              const key2 = `name_${day}_${place}_2`;
              input1.value = LS.getItem(key1) || "";
              input2.value = LS.getItem(key2) || "";

              input1.addEventListener("input", () => {
                LS.setItem(key1, input1.value);
                syncPlaceHeaderForDay(day);
                syncRowHeightsForDay(day);
              });
              input2.addEventListener("input", () => {
                LS.setItem(key2, input2.value);
                syncPlaceHeaderForDay(day);
                syncRowHeightsForDay(day);
              });

              line.appendChild(input1);
              line.appendChild(input2);
            }

            panel.appendChild(line);
          });
        });
      }

      function applyStateClass(td, value) {
        td.className = td.className
          .replace(/state-[^\s]+/g, "")
          .replace(/\bempty\b/g,"")
          .trim();
        if (!value) {
          td.classList.add("slot-cell","empty");
        } else {
          td.classList.add("slot-cell","state-" + value);
        }
      }

      // ロータリー用バックアップはメモリだけで管理
      const rotaryBackup = {};

      function getRotaryTarget(day) {
        if (day === "sat" || day === "sun") {
          return { targetDay: day };
        }
        return { targetDay: day };
      }

      function getRotaryBaseSlots(day) {
        if (day === "sat" || day === "sun") {
          return [0, 1, 2]; // 8:00〜9:00
        }
        return [];
      }

      function getRotarySetting(day, type) {
        if (day === "sat" || day === "sun") {
          if (type === "up") {
            return { slots: [0, 1], mark: "ロ↑" };
          }
          if (type === "down") {
            return { slots: [1, 2], mark: "ロ↓" };
          }
        }
        return { slots: [], mark: "" };
      }

      function restoreOriginalCells(day, place) {
        const backupKey = `${day}_${place}`;
        const data = rotaryBackup[backupKey];
        if (!data) return;

        const target = getRotaryTarget(day);
        const table = document.querySelector(`table.schedule-table[data-day="${target.targetDay}"]`);
        if (!table) return;
        const tr = table.querySelector(`tbody tr[data-place="${place}"]`);
        if (!tr) return;

        Object.keys(data).forEach(slotStr => {
          const td = tr.querySelector(`td[data-slot="${slotStr}"]`);
          if (!td) return;
          const v = data[slotStr] || "";
          td.textContent = v;
          applyStateClass(td, v);
          const cellKey = `cell_${target.targetDay}_${place}_${slotStr}`;
          if (v) {
            LS.setItem(cellKey, v);
          } else {
            LS.removeItem(cellKey);
          }
        });
        delete rotaryBackup[backupKey];
      }

      function applyRotarySelection(day, place, value) {
        const baseSlots = getRotaryBaseSlots(day);
        if (!baseSlots.length) return;

        restoreOriginalCells(day, place);

        if (value !== "up" && value !== "down") {
          return;
        }

        const target = getRotaryTarget(day);
        const table = document.querySelector(`table.schedule-table[data-day="${target.targetDay}"]`);
        if (!table) return;
        const tr = table.querySelector(`tbody tr[data-place="${place}"]`);
        if (!tr) return;

        const backupKey = `${day}_${place}`;
        const backup = {};
        baseSlots.forEach(slotIdx => {
          const td = tr.querySelector(`td[data-slot="${slotIdx}"]`);
          if (!td) return;
          backup[slotIdx] = td.textContent.trim();
        });
        rotaryBackup[backupKey] = backup;

        const cfg = getRotarySetting(day, value);
        const slots = cfg.slots;
        const mark = cfg.mark;
        slots.forEach(slotIdx => {
          const td = tr.querySelector(`td[data-slot="${slotIdx}"]`);
          if (!td) return;
          td.textContent = mark;
          applyStateClass(td, mark);
          const cellKey = `cell_${target.targetDay}_${place}_${slotIdx}`;
          LS.setItem(cellKey, mark);
        });
      }

      function openRotaryMenu(day, place, anchorEl) {
        const old = document.getElementById("rotaryMenu");
        if (old && old.parentNode) {
          old.parentNode.removeChild(old);
        }

        const menu = document.createElement("div");
        menu.id = "rotaryMenu";
        menu.className = "rotary-menu";

        const title = document.createElement("div");
        title.className = "rotary-menu-title";
        let dayLabel = day;
        if (day === "sat") dayLabel = "土曜朝";
        else if (day === "sun") dayLabel = "日曜朝";
        title.textContent = `${place} のロータリー設定（${dayLabel}）`;
        menu.appendChild(title);

        const select = document.createElement("select");

        const optNone = document.createElement("option");
        optNone.value = "";
        optNone.textContent = "（ロータリーなし）";
        select.appendChild(optNone);

        const optUp = document.createElement("option");
        optUp.value = "up";
        optUp.textContent = "ロータリー（↑）8:00〜";
        select.appendChild(optUp);

        const optDown = document.createElement("option");
        optDown.value = "down";
        optDown.textContent = "ロータリー（↓）8:30〜";
        select.appendChild(optDown);

        const key = `rotary_${day}_${place}`;
        select.value = LS.getItem(key) || "";

        menu.appendChild(select);
        document.body.appendChild(menu);

        const rect = anchorEl.getBoundingClientRect();
        menu.style.left = `${rect.right + 8}px`;
        menu.style.top = `${rect.top}px`;

        function closeMenu() {
          if (menu.parentNode) {
            menu.parentNode.removeChild(menu);
          }
        }

        select.addEventListener("change", () => {
          const value = select.value;
          applyRotarySelection(day, place, value);
          if (value) {
            LS.setItem(key, value);
          } else {
            LS.removeItem(key);
          }
          syncPlaceHeaderForDay("sat");
          syncPlaceHeaderForDay("fri");
          syncPlaceHeaderForDay("sun");
          syncAllRowHeights();
          closeMenu();
        });

        setTimeout(() => {
          const handler = (ev) => {
            if (!menu.contains(ev.target)) {
              document.removeEventListener("mousedown", handler);
              closeMenu();
            }
          };
          document.addEventListener("mousedown", handler);
        }, 0);
      }

      function setupRotaryClickHandlers() {
        ["sat","sun"].forEach(day => {
          const placeTable = document.querySelector(`table.place-table[data-day="${day}"]`);
          if (!placeTable) return;

          placeTable.addEventListener("click", (e) => {
            if (!document.body.classList.contains("month-editing")) return;
            const th = e.target.closest(".place-cell");
            if (!th) return;
            const tr = th.parentElement;
            const place = tr.dataset.place || "";
            if (!place) return;
            openRotaryMenu(day, place, th);
          });
        });
      }

      // セル保存／読込（Firestore付き LS）
      function saveCell(td) {
        const day = td.closest("table.schedule-table").dataset.day;
        const place = td.parentElement.dataset.place || "";
        const slot = td.dataset.slot || "";
        const key = `cell_${day}_${place}_${slot}`;
        const value = td.textContent.trim();
        LS.setItem(key, value);
      }

      function loadCellsFromStorage() {
        document.querySelectorAll("table.schedule-table").forEach(table => {
          const day = table.dataset.day;
          table.querySelectorAll("tbody tr").forEach(tr => {
            const place = tr.dataset.place || "";
            tr.querySelectorAll("td[data-slot]").forEach(td => {
              const slot = td.dataset.slot || "";
              const key = `cell_${day}_${place}_${slot}`;
              const value = LS.getItem(key);
              if (value !== null) {
                td.textContent = value;
                applyStateClass(td, value);
              }
            });
          });
        });
      }

      function syncRowHeightsForDay(day){
        const placeTable  = document.querySelector(`table.place-table[data-day="${day}"]`);
        const schedTable  = document.querySelector(`table.schedule-table[data-day="${day}"]`);
        if (!placeTable || !schedTable) return;

        const placeRows = placeTable.querySelectorAll("tbody tr");
        const schedRows = schedTable.querySelectorAll("tbody tr");
        const len = Math.min(placeRows.length, schedRows.length);

        for (let i = 0; i < len; i++){
          const pr = placeRows[i];
          const sr = schedRows[i];
          pr.style.height = "";
          sr.style.height = "";
          const ph = pr.getBoundingClientRect().height;
          const sh = sr.getBoundingClientRect().height;
          const h  = Math.max(ph, sh);
          pr.style.height = h + "px";
          sr.style.height = h + "px";
        }
      }

      function syncAllRowHeights(){
        ["fri","sat","sun"].forEach(syncRowHeightsForDay);
      }

      function normalizeTimeHeaders(){
        document.querySelectorAll(".time-head").forEach(th => {
          const txt = th.textContent.trim();
          const m = txt.match(/^(\d{1,2}):(\d{2})$/);
          if (!m) return;
          let h = m[1];
          const mm = m[2];
          if (h.length === 1) h = "0" + h;
          th.textContent = `${h}:${mm}`;
        });
      }

      function attachCellHandlers() {
        // ここを有効にすればセル直接編集も Firestore 経由で保存できる
        // （いまは月間シフトからの反映＆ロータリー専用なので何もしない）
        return;
      }

      function getCurrentSlotIndex(date, day) {
        const totalMin = date.getHours() * 60 + date.getMinutes();
        let startMin;
        if (day === "fri") {
          startMin = 9 * 60 + 30;
        } else if (day === "sat" || day === "sun") {
          startMin = 8 * 60;
        } else {
          startMin = 0;
        }

        const slotCount = getSlotCountForDay(day);
        let diff = totalMin - startMin;
        diff = (diff % (24 * 60) + (24 * 60)) % (24 * 60);

        let idx = Math.floor(diff / 30);
        if (idx < 0) idx = 0;
        if (idx > slotCount - 1) idx = slotCount - 1;
        return idx;
      }

      function scrollToNowColumn(smooth) {
        if (!daySelect) return;
        let activeDay = daySelect.value;
        if (activeDay && activeDay.includes("-")) {
          const d = new Date(activeDay + "T00:00:00");
          if (!isNaN(d.getTime())) {
            const dow = d.getDay();
            if (dow === 5) activeDay = "fri";
            else if (dow === 6) activeDay = "sat";
            else if (dow === 0) activeDay = "sun";
          }
        }
        const wrapper = document.querySelector(`.day-wrapper[data-day="${activeDay}"]`);
        if (!wrapper) return;
        const container = wrapper.querySelector(".table-container");
        const table = wrapper.querySelector("table.schedule-table");
        if (!container || !table) return;

        const target =
          table.querySelector("thead th.now-col") ||
          table.querySelector("tbody td.now-col");
        if (!target) return;

        const targetLeft = target.offsetLeft;
        const margin = 0;
        let desired = targetLeft - margin;
        if (desired < 0) desired = 0;

        const maxScroll = container.scrollWidth - container.clientWidth;
        if (desired > maxScroll) desired = maxScroll;

        container.scrollTo({
          left: desired,
          behavior: smooth ? "smooth" : "auto"
        });
      }

      function updateNowColumn(fromTimer) {
        const now = new Date();
        let activeDay = daySelect.value;
        if (activeDay && activeDay.includes("-")) {
          const d = new Date(activeDay + "T00:00:00");
          if (!isNaN(d.getTime())) {
            const dow = d.getDay();
            if (dow === 5) activeDay = "fri";
            else if (dow === 6) activeDay = "sat";
            else if (dow === 0) activeDay = "sun";
          }
        }
        const idx = getCurrentSlotIndex(now, activeDay);

        const changed = (prevSlotIndex === null || prevSlotIndex !== idx);
        prevSlotIndex = idx;

        document.querySelectorAll("table.schedule-table").forEach(table => {
          const isActive = table.dataset.day === activeDay;
          table.querySelectorAll(".now-col").forEach(el => el.classList.remove("now-col"));
          if (!isActive) return;
          table.querySelectorAll(`[data-slot="${idx}"]`).forEach(el => {
            el.classList.add("now-col");
          });
        });

        const hh = String(now.getHours()).padStart(2,"0");
        const mm = String(now.getMinutes()).padStart(2,"0");
        currentTimeEl.textContent = `現在時刻 ${hh}:${mm}`;

        if (changed) {
          scrollToNowColumn(!!fromTimer);
        }
      }

      function setActiveDay(day) {
        document.querySelectorAll(".day-wrapper").forEach(w => {
          w.classList.toggle("active", w.dataset.day === day);
        });
        document.querySelectorAll(".names-panel").forEach(p => {
          p.classList.toggle("active", p.dataset.day === day);
        });
        prevSlotIndex = null;
        updateNowColumn(false);
        syncRowHeightsForDay(day);
      }

      function getActiveMonthStr() {
        if (!monthPicker) return "";
        let ym = monthPicker.value;
        if (!ym) {
          const now = new Date();
          const m = String(now.getMonth() + 1).padStart(2, "0");
          ym = `${now.getFullYear()}-${m}`;
          monthPicker.value = ym;
        }
        return ym;
      }

      function getFriSatSunDatesForActiveMonth() {
        const ym = getActiveMonthStr();
        if (!ym) return [];
        const [yStr, mStr] = ym.split("-");
        const y = parseInt(yStr, 10);
        const m = parseInt(mStr, 10) - 1;
        const dates = [];
        if (isNaN(y) || isNaN(m)) return dates;
        const d = new Date(y, m, 1);
        const wNames = ["日", "月", "火", "水", "木", "金", "土"];
        while (d.getMonth() === m) {
          const dow = d.getDay();
          if (dow === 5 || dow === 6 || dow === 0) {
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, "0");
            const dd = String(d.getDate()).padStart(2, "0");
            const dateStr = `${yyyy}-${mm}-${dd}`;
            const label = `${mm}/${dd}(${wNames[dow]})`;
            const dayKey = (dow === 5 ? "fri" : dow === 6 ? "sat" : "sun");
            dates.push({ dateStr, label, dayKey });
          }
          d.setDate(d.getDate() + 1);
        }
        return dates;
      }

      function rebuildDaySelectForActiveMonth() {
        if (!daySelect) return;
        const infos = getFriSatSunDatesForActiveMonth();
        daySelect.innerHTML = "";
        infos.forEach(info => {
          const opt = document.createElement("option");
          opt.value = info.dateStr;
          opt.textContent = info.label;
          daySelect.appendChild(opt);
        });
        if (!infos.length) return;

        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, "0");
        const dd = String(today.getDate()).padStart(2, "0");
        const todayStr = `${yyyy}-${mm}-${dd}`;
        const hasToday = infos.some(info => info.dateStr === todayStr);
        if (hasToday) {
          daySelect.value = todayStr;
        }
        applySelectedDateToSchedule();
      }

      function applySelectedDateToSchedule() {
        if (!daySelect || !daySelect.value) return;
        const dateStr = daySelect.value;
        const d = new Date(dateStr + "T00:00:00");
        if (isNaN(d.getTime())) return;
        const dow = d.getDay();
        const dayKey = (dow === 5 ? "fri" : dow === 6 ? "sat" : dow === 0 ? "sun" : null);
        if (!dayKey) return;

        applyMonthShiftToSchedule(dateStr, dayKey);
        setActiveDay(dayKey);
      }

      function applyMonthShiftToSchedule(dateStr, dayKey) {
        const ym = dateStr.slice(0,7);
        const key = `monthshift_${ym}`;
        let rows = [];
        try {
          const raw = LS.getItem(key);
          if (raw) {
            const parsed = JSON.parse(raw);
            if (Array.isArray(parsed)) rows = parsed;
          }
        } catch(e) {
          console.warn("月間シフト読み込み失敗", e);
        }
        if (!rows.length) return;

        const dateInfos = getFriSatSunDatesForActiveMonth();
        const targetInfo = dateInfos.find(info => info.dateStr === dateStr);
        if (!targetInfo) return;

        const allPlaces = PLACES.slice();
        const otherPlaces = allPlaces.filter(p => p !== "厩舎長");

        allPlaces.forEach(place => {
          LS.removeItem(`name_${dayKey}_${place}_1`);
          LS.removeItem(`name_${dayKey}_${place}_2`);
        });

        const placeToNames = {};

        rows.forEach(row => {
          const rawName = (row.name || "").trim();
          if (!rawName) return;
          const asg = row.assignments || {};
          const code = asg[dateStr];
          if (!code) return;

          if (code === "O" || code === "X") {
            const place = "厩舎長";
            if (!placeToNames[place]) placeToNames[place] = [];
            placeToNames[place].push(rawName);
            return;
          }

          const m = code.match(/^([OXY])(\d)$/);
          if (!m) return;
          const num = parseInt(m[2], 10);
          if (!(num >= 1 && num <= 7)) return;
          const idx = num - 1;
          if (idx < 0 || idx >= otherPlaces.length) return;
          const place = otherPlaces[idx];
          if (!place) return;
          if (!placeToNames[place]) placeToNames[place] = [];
          placeToNames[place].push(rawName);
        });

        Object.keys(placeToNames).forEach(place => {
          const arr = placeToNames[place];
          if (!arr || !arr.length) return;
          const n1 = arr[0];
          const n2 = arr[1];

          if (place === "厩舎長") {
            LS.setItem(`name_${dayKey}_${place}_1`, n1);
          } else {
            LS.setItem(`name_${dayKey}_${place}_1`, n1);
            if (n2) {
              LS.setItem(`name_${dayKey}_${place}_2`, n2);
            }
          }
        });

        buildNamePanels();
        syncPlaceHeaderForDay(dayKey);
        syncRowHeightsForDay(dayKey);
      }

      function saveMonthShiftTable() {
        if (!monthPicker || !msBody) return;
        const ym = getActiveMonthStr();
        const key = `monthshift_${ym}`;

        const rows = [];
        const dateInfos = getFriSatSunDatesForActiveMonth();
        const dateStrs = dateInfos.map(d => d.dateStr);

        msBody.querySelectorAll("tr").forEach(tr => {
          const nameInput = tr.querySelector("td.month-shift-name input");
          if (!nameInput) return;
          const name = nameInput.value.trim();
          const assignments = {};
          dateStrs.forEach((ds, idx) => {
            const sel = tr.querySelector(`td[data-col="${idx}"] select`);
            if (!sel) return;
            const v = sel.value;
            if (v) assignments[ds] = v;
          });
          if (!name && Object.keys(assignments).length === 0) return;
          rows.push({ name, assignments });
        });

        try {
          LS.setItem(key, JSON.stringify(rows));
        } catch (e) {
          console.warn("月間シフトの保存に失敗しました", e);
        }
      }

      function appendMonthShiftRow(rowData, dateInfos) {
        if (!msBody) return;
        const tr = document.createElement("tr");

        const nameTd = document.createElement("td");
        nameTd.className = "month-shift-name";
        const nameInput = document.createElement("input");
        nameInput.type = "text";
        nameInput.value = rowData.name || "";
        nameTd.appendChild(nameInput);
        tr.appendChild(nameTd);

        dateInfos.forEach((info, idx) => {
          const td = document.createElement("td");
          td.dataset.col = String(idx);
          const sel = document.createElement("select");

          const addOpt = (val, label) => {
            const o = document.createElement("option");
            o.value = val;
            o.textContent = label;
            sel.appendChild(o);
          };

          addOpt("", "-");
          addOpt("O", "O（厩舎長 当直）");
          addOpt("X", "X（厩舎長 日勤）");
          ["O","X","Y"].forEach(prefix => {
            for (let i = 1; i <= 7; i++) {
              const code = `${prefix}${i}`;
              addOpt(code, code);
            }
          });

          const assigned = (rowData.assignments && rowData.assignments[info.dateStr]) || "";
          sel.value = assigned;

          sel.addEventListener("change", () => {
            saveMonthShiftTable();
          });

          td.appendChild(sel);
          tr.appendChild(td);
        });

        nameInput.addEventListener("input", () => {
          saveMonthShiftTable();
        });

        msBody.appendChild(tr);
      }

      function loadMonthShiftData() {
        if (!monthPicker) return [];
        const ym = getActiveMonthStr();
        const key = `monthshift_${ym}`;
        try {
          const raw = LS.getItem(key);
          if (!raw) return [];
          const parsed = JSON.parse(raw);
          if (!Array.isArray(parsed)) return [];
          return parsed;
        } catch (e) {
          console.warn("月間シフト読み込み失敗", e);
          return [];
        }
      }

      function renderMonthShiftTable() {
        if (!msHeadRow || !msBody) return;
        const dateInfos = getFriSatSunDatesForActiveMonth();

        msHeadRow.innerHTML = "";
        const thName = document.createElement("th");
        thName.textContent = "氏名";
        msHeadRow.appendChild(thName);

        dateInfos.forEach(info => {
          const th = document.createElement("th");
          th.textContent = info.label;
          msHeadRow.appendChild(th);
        });

        msBody.innerHTML = "";

        const rows = loadMonthShiftData();
        if (!rows.length) {
          appendMonthShiftRow({ name: "", assignments: {} }, dateInfos);
        } else {
          rows.forEach(row => appendMonthShiftRow(row, dateInfos));
        }
      }

      // ==== 起動処理 ====
      document.addEventListener("DOMContentLoaded", async () => {
        // まず Firestore から LS 相当のキーを全部読み込む
        await preloadLSFromFirestore();

        buildScheduleHeads();
        buildPlaceTableBodies();
        buildScheduleBodies();
        buildNamePanels();
        attachCellHandlers();
        loadCellsFromStorage();
        syncAllPlaceHeaders();
        normalizeTimeHeaders();
        syncAllRowHeights();
        setupRotaryClickHandlers();

        if (editToggle) {
          editToggle.addEventListener("change", () => {
            document.body.classList.toggle("month-editing", editToggle.checked);
          });
        }

        if (daySelect) {
          daySelect.addEventListener("change", () => {
            applySelectedDateToSchedule();
          });
        }

        if (monthPicker) {
          if (!monthPicker.value) {
            const now = new Date();
            const m = String(now.getMonth() + 1).padStart(2, "0");
            monthPicker.value = `${now.getFullYear()}-${m}`;
          }
          monthPicker.addEventListener("change", () => {
            renderMonthShiftTable();
            rebuildDaySelectForActiveMonth();
          });
        }

        if (msAddPerson) {
          msAddPerson.addEventListener("click", () => {
            const infos = getFriSatSunDatesForActiveMonth();
            appendMonthShiftRow({ name: "", assignments: {} }, infos);
            saveMonthShiftTable();
          });
        }

        if (msApplyButton) {
          msApplyButton.addEventListener("click", () => {
            saveMonthShiftTable();
            if (daySelect && daySelect.value) {
              applySelectedDateToSchedule();
            }
            alert("月間シフトを保存しました。");
          });
        }

        renderMonthShiftTable();
        rebuildDaySelectForActiveMonth();

        updateNowColumn(false);
        setInterval(() => updateNowColumn(true), 60000);

        window.addEventListener("resize", () => {
          syncAllRowHeights();
        });
      });
    })();
  </script>
</body>
</html>
