<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>中京競馬場 滞在場所特別警備 立座表（新レイアウト）</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "YuGothic", "Yu Gothic", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      color: #333;
    }
    .wrapper {
      padding: 12px;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 8px;
      font-size: 14px;
    }
    .controls label {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    select, input[type="checkbox"] {
      font-size: 14px;
    }
    #currentTime {
      margin-left: auto;
      font-weight: 600;
    }

    /* ===== レイアウト全体（1日分） ===== */
    .day-wrapper {
      margin-top: 8px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
      padding: 8px;
      max-height: 70vh;
      overflow: auto;          /* 縦スクロールは1日ごと */
      display: none;
    }
    .day-wrapper.active {
      display: block;
    }

    .day-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
      padding: 4px 6px;
      background: #2b5fb8;
      color: #fff;
      border-radius: 4px;
    }

    .schedule-main {
      display: flex;
      align-items: flex-start;
      gap: 4px;
    }

    .fixed-col {
      flex: 0 0 150px;  /* 左の配置カラムは固定幅 */
    }

    .scroll-col {
      flex: 1 1 auto;
      min-width: 0;
    }

    .table-container {
      position: relative;
      overflow-x: auto;   /* 横スクロールはここだけ */
      overflow-y: hidden; /* 縦スクロールは day-wrapper に任せる */
    }

    /* ===== テーブル共通 ===== */
    table {
      border-collapse: collapse;
      table-layout: fixed;
      font-size: 12px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 3px 4px;
      text-align: center;
      white-space: nowrap;
    }

    /* 左側：配置のみのテーブル */
    table.place-table {
      width: 100%;
    }
    .place-head {
      background: #f0f3f8;
      font-size: 13px;
      text-align: left;
    }
    th.place-cell {
      background: #fafafa;
      text-align: left;
      line-height: 1.3;
      height: 3em;
      white-space: normal; /* 名前＋（配置）で2行OK */
      font-weight: 600;
    }

    /* 右側：時間スロットのテーブル */
    table.schedule-table {
      min-width: 1200px;
    }

    .schedule-table thead th {
      background: #f0f3f8;
      position: sticky;
      top: 0;
      z-index: 5;
    }
    .schedule-table thead th.time-head {
      font-size: 12px;
    }

    td.slot-cell {
      background: #fff;
    }
    td.empty {
      background: #fff;
    }

    /* 状態ごとの色 */
    td.state-本 { background: #fff; }
    td.state-立 { background: #fff; }
    td.state-座 { background: #fff; }
    td.state-巡 { background: #d8ffd8; }
    td.state-東 { background: #d8e8ff; }
    td.state-仮眠 { background: #e6e6e6; }
    td.state-休 { background: #f9d8d8; }
    td.state-掃 { background: #d8f9ed; }
    td.state-待 { background: #f0e0ff; }
    td.state-準 { background: #e0f0ff; }
    /* ロータリー用（薄い黄色） */
    td.state-ロ↑,
    td.state-ロ↓ { background: #fffbe6; }

    /* ロータリー設定用の小さなポップアップ */
    .rotary-menu {
      position: fixed;
      z-index: 2000;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 6px 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      font-size: 12px;
      max-width: 200px;
    }
    .rotary-menu-title {
      margin-bottom: 4px;
      font-size: 11px;
      color: #555;
      white-space: nowrap;
    }
    .rotary-menu select {
      font-size: 12px;
      width: 100%;
    }

    /* 現在時刻の30分枠 */
    .now-col {
      box-shadow: inset 0 0 0 2px #ff5722;
      background-image: linear-gradient(to bottom, rgba(255,87,34,0.12), rgba(255,87,34,0.02));
    }
    .schedule-table thead th.now-col {
      background: #ff5722;
      color: #fff;
    }

    /* セル編集は無効化（閲覧専用） */
    td[data-slot] {
      cursor: default;
    }
    body.month-editing td[data-slot] {
      outline: none;
    }

    .legend {
      margin-top: 6px;
      font-size: 11px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .legend span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .legend-box {
      width: 14px;
      height: 14px;
      border-radius: 3px;
      border: 1px solid #ccc;
    }
    .legend-box.state-本 { background: #d8f0ff; }
    .legend-box.state-立 { background: #ffe0d8; }
    .legend-box.state-座 { background: #e9ffd8; }
    .legend-box.state-巡 { background: #fff6cc; }
    .legend-box.state-東 { background: #f5d8ff; }
    .legend-box.state-仮眠 { background: #e6e6e6; }
    .legend-box.state-休 { background: #f9d8d8; }
    .legend-box.state-掃 { background: #d8f9ed; }
    .legend-box.state-待 { background: #f0e0ff; }
    .legend-box.state-準 { background: #e0f0ff; }

    /* 名前欄 */
    .names-wrapper {
      margin-top: 10px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
      padding: 8px;
      font-size: 12px;
    }
    .names-panel {
      display: none;
    }
    .names-panel.active {
      display: block;
    }
    .name-line {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      margin-bottom: 4px;
    }
    .name-line-label {
      min-width: 80px;
      font-weight: 600;
    }
    .name-line input {
      font-size: 12px;
      padding: 2px 4px;
      width: 120px;
    }

    /* ★ 配置ヘッダーと時間ヘッダーの高さを揃える */
    .place-head,
    .schedule-table thead th.time-head {
      height: 40px;        /* 好きな値でOK。32〜44ぐらいで調整 */
      line-height: 40px;   /* 縦位置も中央寄せ */
      box-sizing: border-box;
    }

    /* 月間シフト編集エリア */
    .month-shift-editor {
      margin-top: 12px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
      padding: 8px;
      font-size: 12px;
      display: none; /* 編集モードのときだけ表示 */
    }
    body.month-editing .month-shift-editor {
      display: block;
    }
    .month-shift-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      font-weight: 600;
    }
    .month-shift-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .month-shift-controls label {
      font-size: 11px;
    }
    .month-shift-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      font-size: 11px;
    }
    .month-shift-table th,
    .month-shift-table td {
      border: 1px solid #ddd;
      padding: 2px;
      text-align: center;
      white-space: nowrap;
    }
    .month-shift-name {
      min-width: 90px;
      text-align: left;
      padding-left: 4px;
    }
    .month-shift-name input {
      width: 100%;
      box-sizing: border-box;
      font-size: 11px;
    }
    .month-shift-table select {
      width: 100%;
      box-sizing: border-box;
      font-size: 11px;
    }
    .month-shift-hint {
      margin-top: 4px;
      font-size: 10px;
      color: #666;
    }

    /* 配置者の手入力欄は現在は使用しないので非表示 */
    .names-wrapper {
      display: none !important;
    }

    @media (max-width: 768px) {
      .wrapper {
        padding: 8px;
      }
      table.schedule-table {
        min-width: 900px;
      }
      .fixed-col {
        flex-basis: 130px;
      }
    }
  </style>

  <!-- Firebase (Firestore) 用スクリプト -->
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore-compat.js"></script>
  <script>
  const firebaseConfig = {
    apiKey: "AIzaSyCNUZdZeE9t6EFg9tDhSVF2qPcgiyPlrUs",
    authDomain: "cktaizai-c197d.firebaseapp.com",
    projectId: "cktaizai-c197d",
    storageBucket: "cktaizai-c197d.firebasestorage.app",
    messagingSenderId: "434618441616",
    appId: "1:434618441616:web:dd87d2d1f9385b697a9d15",
    measurementId: "G-1BZNEGWFZE"
  };
    firebase.initializeApp(firebaseConfig);
    window.db = firebase.firestore();
  </script>
</head>
<body>
  <div class="wrapper">
    <div class="controls">
      <label>
        日付:
        <!-- JSで金土日の一覧に差し替える -->
        <select id="daySelect">
          <option value="fri">金曜 → 土曜</option>
          <option value="sat" selected>土曜 → 日曜</option>
          <option value="sun">日曜 → 終了</option>
        </select>
      </label>
      <label>
        <input type="checkbox" id="editToggle">
        編集モード
      </label>
      <span id="currentTime"></span>
    </div>

    <!-- ===== 金曜 → 土曜 ===== -->
    <div class="day-wrapper" data-day="fri">
      <div class="day-title">滞在場所特別警備 立座表（金曜日＞土曜日・30分刻み）</div>
      <div class="schedule-main">
        <!-- 左：配置＋名前 -->
        <div class="fixed-col">
          <table class="place-table" data-day="fri">
            <thead>
              <tr><th class="place-head">配置</th></tr>
            </thead>
            <tbody>
              <!-- JSで行を生成 -->
            </tbody>
          </table>
        </div>
        <!-- 右：時間スロット -->
        <div class="scroll-col">
          <div class="table-container">
            <table class="schedule-table" data-day="fri">
              <thead>
                <tr>
                  <th class="time-head" data-slot="0">9:30</th>
                  <th class="time-head" data-slot="1">10:00</th>
                  <th class="time-head" data-slot="2">10:30</th>
                  <th class="time-head" data-slot="3">11:00</th>
                  <th class="time-head" data-slot="4">11:30</th>
                  <th class="time-head" data-slot="5">12:00</th>
                  <th class="time-head" data-slot="6">12:30</th>
                  <th class="time-head" data-slot="7">13:00</th>
                  <th class="time-head" data-slot="8">13:30</th>
                  <th class="time-head" data-slot="9">14:00</th>
                  <th class="time-head" data-slot="10">14:30</th>
                  <th class="time-head" data-slot="11">15:00</th>
                  <th class="time-head" data-slot="12">15:30</th>
                  <th class="time-head" data-slot="13">16:00</th>
                  <th class="time-head" data-slot="14">16:30</th>
                  <th class="time-head" data-slot="15">17:00</th>
                  <th class="time-head" data-slot="16">17:30</th>
                  <th class="time-head" data-slot="17">18:00</th>
                  <th class="time-head" data-slot="18">18:30</th>
                  <th class="time-head" data-slot="19">19:00</th>
                  <th class="time-head" data-slot="20">19:30</th>
                  <th class="time-head" data-slot="21">20:00</th>
                  <th class="time-head" data-slot="22">20:30</th>
                  <th class="time-head" data-slot="23">21:00</th>
                  <th class="time-head" data-slot="24">21:30</th>
                  <th class="time-head" data-slot="25">22:00</th>
                  <th class="time-head" data-slot="26">22:30</th>
                  <th class="time-head" data-slot="27">23:00</th>
                  <th class="time-head" data-slot="28">23:30</th>
                  <th class="time-head" data-slot="29">24:00</th>
                  <th class="time-head" data-slot="30">24:30</th>
                  <th class="time-head" data-slot="31">1:00</th>
                  <th class="time-head" data-slot="32">1:30</th>
                  <th class="time-head" data-slot="33">2:00</th>
                  <th class="time-head" data-slot="34">2:30</th>
                  <th class="time-head" data-slot="35">3:00</th>
                  <th class="time-head" data-slot="36">3:30</th>
                  <th class="time-head" data-slot="37">4:00</th>
                  <th class="time-head" data-slot="38">4:30</th>
                  <th class="time-head" data-slot="39">5:00</th>
                  <th class="time-head" data-slot="40">5:30</th>
                  <th class="time-head" data-slot="41">6:00</th>
                  <th class="time-head" data-slot="42">6:30</th>
                  <th class="time-head" data-slot="43">7:00</th>
                  <th class="time-head" data-slot="44">7:30</th>
                  <th class="time-head" data-slot="45">8:00</th>
                  <th class="time-head" data-slot="46">8:30</th>
                  <th class="time-head" data-slot="47">9:00</th>
                  <th class="time-head" data-slot="48">9:30</th>
                </tr>
              </thead>
              <tbody>
                <!-- JSで行を生成 -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== 土曜 → 日曜 ===== -->
    <div class="day-wrapper" data-day="sat">
      <div class="day-title">滞在場所特別警備 立座表（土曜日＞日曜日・30分刻み）</div>
      <div class="schedule-main">
        <div class="fixed-col">
          <table class="place-table" data-day="sat">
            <thead>
              <tr><th class="place-head">配置</th></tr>
            </thead>
            <tbody>
              <!-- JSで行を生成 -->
            </tbody>
          </table>
        </div>
        <div class="scroll-col">
          <div class="table-container">
            <table class="schedule-table" data-day="sat">
              <thead>
                <tr>
                  <th class="time-head" data-slot="0">8:00</th>
                  <th class="time-head" data-slot="1">8:30</th>
                  <th class="time-head" data-slot="2">9:00</th>
                  <th class="time-head" data-slot="3">9:30</th>
                  <th class="time-head" data-slot="4">10:00</th>
                  <th class="time-head" data-slot="5">10:30</th>
                  <th class="time-head" data-slot="6">11:00</th>
                  <th class="time-head" data-slot="7">11:30</th>
                  <th class="time-head" data-slot="8">12:00</th>
                  <th class="time-head" data-slot="9">12:30</th>
                  <th class="time-head" data-slot="10">13:00</th>
                  <th class="time-head" data-slot="11">13:30</th>
                  <th class="time-head" data-slot="12">14:00</th>
                  <th class="time-head" data-slot="13">14:30</th>
                  <th class="time-head" data-slot="14">15:00</th>
                  <th class="time-head" data-slot="15">15:30</th>
                  <th class="time-head" data-slot="16">16:00</th>
                  <th class="time-head" data-slot="17">16:30</th>
                  <th class="time-head" data-slot="18">17:00</th>
                  <th class="time-head" data-slot="19">17:30</th>
                  <th class="time-head" data-slot="20">18:00</th>
                  <th class="time-head" data-slot="21">18:30</th>
                  <th class="time-head" data-slot="22">19:00</th>
                  <th class="time-head" data-slot="23">19:30</th>
                  <th class="time-head" data-slot="24">20:00</th>
                  <th class="time-head" data-slot="25">20:30</th>
                  <th class="time-head" data-slot="26">21:00</th>
                  <th class="time-head" data-slot="27">21:30</th>
                  <th class="time-head" data-slot="28">22:00</th>
                  <th class="time-head" data-slot="29">22:30</th>
                  <th class="time-head" data-slot="30">23:00</th>
                  <th class="time-head" data-slot="31">23:30</th>
                  <th class="time-head" data-slot="32">0:00</th>
                  <th class="time-head" data-slot="33">0:30</th>
                  <th class="time-head" data-slot="34">1:00</th>
                  <th class="time-head" data-slot="35">1:30</th>
                  <th class="time-head" data-slot="36">2:00</th>
                  <th class="time-head" data-slot="37">2:30</th>
                  <th class="time-head" data-slot="38">3:00</th>
                  <th class="time-head" data-slot="39">3:30</th>
                  <th class="time-head" data-slot="40">4:00</th>
                  <th class="time-head" data-slot="41">4:30</th>
                  <th class="time-head" data-slot="42">5:00</th>
                  <th class="time-head" data-slot="43">5:30</th>
                  <th class="time-head" data-slot="44">6:00</th>
                  <th class="time-head" data-slot="45">6:30</th>
                  <th class="time-head" data-slot="46">7:00</th>
                  <th class="time-head" data-slot="47">7:30</th>
                  <th class="time-head" data-slot="48">8:00</th>
                  <th class="time-head" data-slot="49">8:30</th>
                  <th class="time-head" data-slot="50">9:00</th>
                  <th class="time-head" data-slot="51">9:30</th>
                </tr>
              </thead>
              <tbody>
                <!-- JSで行を生成 -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== 日曜 → 終了 ===== -->
    <div class="day-wrapper" data-day="sun">
      <div class="day-title">滞在場所特別警備 立座表（日曜日＞終了・30分刻み）</div>
      <div class="schedule-main">
        <div class="fixed-col">
          <table class="place-table" data-day="sun">
            <thead>
              <tr><th class="place-head">配置</th></tr>
            </thead>
            <tbody>
              <!-- JSで行を生成 -->
            </tbody>
          </table>
        </div>
        <div class="scroll-col">
          <div class="table-container">
            <table class="schedule-table" data-day="sun">
              <thead>
                <tr>
                  <th class="time-head" data-slot="0">8:00</th>
                  <th class="time-head" data-slot="1">8:30</th>
                  <th class="time-head" data-slot="2">9:00</th>
                  <th class="time-head" data-slot="3">9:30</th>
                  <th class="time-head" data-slot="4">10:00</th>
                  <th class="time-head" data-slot="5">10:30</th>
                  <th class="time-head" data-slot="6">11:00</th>
                  <th class="time-head" data-slot="7">11:30</th>
                  <th class="time-head" data-slot="8">12:00</th>
                  <th class="time-head" data-slot="9">12:30</th>
                  <th class="time-head" data-slot="10">13:00</th>
                  <th class="time-head" data-slot="11">13:30</th>
                  <th class="time-head" data-slot="12">14:00</th>
                  <th class="time-head" data-slot="13">14:30</th>
                  <th class="time-head" data-slot="14">15:00</th>
                  <th class="time-head" data-slot="15">15:30</th>
                  <th class="time-head" data-slot="16">16:00</th>
                  <th class="time-head" data-slot="17">16:30</th>
                  <th class="time-head" data-slot="18">17:00</th>
                  <th class="time-head" data-slot="19">17:30</th>
                  <th class="time-head" data-slot="20">18:00</th>
                  <th class="time-head" data-slot="21">18:30</th>
                  <th class="time-head" data-slot="22">19:00</th>
                  <th class="time-head" data-slot="23">19:30</th>
                  <th class="time-head" data-slot="24">20:00</th>
                </tr>
              </thead>
              <tbody>
                <!-- JSで行を生成 -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- 凡例 -->
    <div class="legend">
      <span><span class="legend-box state-本"></span>本</span>
      <span><span class="legend-box state-立"></span>立</span>
      <span><span class="legend-box state-座"></span>座</span>
      <span><span class="legend-box state-巡"></span>巡</span>
      <span><span class="legend-box state-東"></span>東</span>
      <span><span class="legend-box state-仮眠"></span>仮眠</span>
      <span><span class="legend-box state-休"></span>休</span>
      <span><span class="legend-box state-掃"></span>掃</span>
      <span><span class="legend-box state-待"></span>待</span>
      <span><span class="legend-box state-準"></span>準</span>
    </div>

    <!-- 名前入力パネル（現状非表示） -->
    <div class="names-wrapper">
      <div class="names-panel" data-day="fri"></div>
      <div class="names-panel" data-day="sat"></div>
      <div class="names-panel" data-day="sun"></div>
    </div>

    <!-- 月間シフト（金・土・日） -->
    <div class="month-shift-editor">
      <div class="month-shift-header">
        月間シフト（金・土・日）
      </div>
      <div class="month-shift-controls">
        <label>対象月:
          <input type="month" id="monthPicker">
        </label>
        <button type="button" id="msAddPerson">＋ 人追加</button>
        <button type="button" id="msApplyToSchedule">保存</button>
      </div>
      <div class="month-shift-scroll">
        <table class="month-shift-table">
          <thead>
            <tr id="monthShiftHeadRow"></tr>
          </thead>
          <tbody id="monthShiftBody"></tbody>
        </table>
      </div>
      <div class="month-shift-hint">
        ※ 各セルで O / X / O1〜O7 / X1〜X7 / Y1〜Y7 を指定できます。O / X は厩舎長用です。
      </div>
    </div>
  </div>

  <script>
    (function(){
      const PLACES = [
        "厩舎長",
        "外厩門 1",
        "外厩門 2",
        "外厩門 3",
        "外厩門 4",
        "西通用門 4",
        "西通用門 5",
        "西通用門 6",
        "西通用門 7"
      ];
      const STATES = ["", "本", "立", "座", "巡", "東", "仮眠", "休", "掃", "待", "準", "ロ↑", "ロ↓"];

      const daySelect = document.getElementById("daySelect");
      const editToggle = document.getElementById("editToggle");
      const currentTimeEl = document.getElementById("currentTime");
      const monthPicker = document.getElementById("monthPicker");
      const msAddPerson = document.getElementById("msAddPerson");
      const msApplyButton = document.getElementById("msApplyToSchedule");
      const msHeadRow = document.getElementById("monthShiftHeadRow");
      const msBody = document.getElementById("monthShiftBody");

      // Firestore 設定
      const scheduleDocRef = db.collection("standSchedule").doc("main");
      let remoteConfig = {
        monthShifts: {},
        rotary: { sat: {}, sun: {} }
      };
      let currentMonthStr = "";
      let currentMonthRows = [];
      const namesStore = { fri: {}, sat: {}, sun: {} };

      async function loadRemoteConfig() {
        try {
          const snap = await scheduleDocRef.get();
          if (snap.exists) {
            const data = snap.data() || {};
            if (data.monthShifts && typeof data.monthShifts === "object") {
              remoteConfig.monthShifts = data.monthShifts;
            }
            if (data.rotary && typeof data.rotary === "object") {
              remoteConfig.rotary = data.rotary;
            }
          }
        } catch (e) {
          console.warn("Firestore 読み込み失敗", e);
        }
      }

      async function saveRemoteConfig(partial) {
        try {
          // ローカルキャッシュも更新
          remoteConfig = {
            ...remoteConfig,
            ...partial
          };
          await scheduleDocRef.set(partial, { merge: true });
        } catch (e) {
          console.warn("Firestore 保存失敗", e);
        }
      }

      // 金曜49、土日ほか
      const SLOT_COUNTS = {
        fri: 49,
        sat: 52,
        sun: 25
      };

      // 土曜日の初期データ（確定版）＋金曜・日曜
      const INITIAL_DATA = {
        // =========================
        // 金曜日（0〜48：49コ）
        // =========================
        fri: {
          "厩舎長": [
            "本", "本", "待", "本", "本", "本", "本", "休", "休", "本", "本", "本", "本", "本", "本", "本", "本", "本",
            "本", "休", "休", "本", "本", "本", "本", "休", "本", "本", "本", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠",
            "仮眠", "仮眠", "本", "本", "本", "本", "本", "本", "本", "本", "本", "本", "本", "本"
          ],
          "外厩門 1": [
            "座", "立", "待", "東", "東", "休", "立", "座", "立", "東", "東", "休", "休", "座", "立", "休", "休", "東",
            "東", "座", "座", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "巡", "巡", "巡", "座", "座", "座",
            "巡", "巡", "巡", "座", "立", "座", "立", "座", "立", "座", "座", "立", "座", "掃"
          ],
          "外厩門 2": [
            "座", "座", "待", "立", "座", "東", "東", "休", "休", "座", "立", "座", "立", "東", "東", "座", "立", "座",
            "立", "休", "休", "座", "座", "休", "巡", "巡", "巡", "座", "座", "座", "座", "座", "巡", "巡", "巡", "座",
            "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "座", "立", "東", "東", "休", "立"
          ],
          "外厩門 3": [
            "立", "待", "立", "座", "立", "座", "休", "立", "座", "休", "休", "立", "座", "立", "座", "東", "東", "休",
            "休", "座", "座", "東", "東", "座", "座", "座", "座", "巡", "巡", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠",
            "仮眠", "仮眠", "座", "座", "座", "座", "立", "座", "東", "東", "立", "座", "立", "座"
          ],
          "外厩門 4": [
            "座", "待", "座", "休", "休", "立", "座", "東", "東", "立", "座", "東", "東", "休", "休", "立", "座", "座",
            "座", "東", "東", "巡", "巡", "巡", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "",
            "", "", "", "", "", "", "", "", ""
          ],
          "西通用門 4": [
            "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "",
            "", "座", "座", "座", "座", "休", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "座", "巡", "巡",
            "巡", "巡", "座", "立", "座", "立", "掃", "休", "座"
          ],
          "西通用門 5": [
            "立", "待", "座", "休", "休", "立", "座", "本", "本", "立", "座", "休", "立", "座", "立", "休", "休", "座",
            "座", "座", "座", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "座", "座", "座", "本", "本", "本",
            "巡", "巡", "巡", "座", "座", "座", "座", "立", "座", "立", "休", "座", "立", "掃"
          ],
          "西通用門 6": [
            "座", "立", "本", "立", "座", "休", "立", "座", "立", "座", "立", "座", "休", "休", "座", "立", "座", "休",
            "座", "座", "座", "巡", "巡", "巡", "休", "座", "座", "巡", "巡", "本", "本", "本", "巡", "巡", "巡", "座",
            "座", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "待", "休", "座", "立"
          ],
          "西通用門 7": [
            "座", "座", "立", "座", "立", "座", "待", "立", "座", "休", "休", "立", "座", "立", "待", "座", "立", "座",
            "休", "本", "本", "座", "座", "座", "巡", "巡", "巡", "休", "座", "巡", "巡", "巡", "座", "座", "座", "本",
            "本", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "座", "立", "休", "座"
          ]
        },

        // =========================
        // 土曜日（8:00〜翌10:00：52コ・0〜3は8:00〜9:30の空白）
        // =========================
        sat: {
          "厩舎長": [
            "", "", "", "", "本", "本", "休", "本", "本", "本", "本", "本", "休", "休", "本", "本", "本", "本", "休",
            "本", "本", "本", "休", "休", "本", "本", "本", "本", "休", "本", "本", "本", "仮眠", "仮眠", "仮眠", "仮眠",
            "仮眠", "仮眠", "仮眠", "仮眠", "本", "本", "本", "本", "本", "本", "本", "本", "本", "待", "本", "本"
          ],
          "外厩門 1": [
            "", "", "", "", "座", "休", "休", "座", "立", "休", "東", "東", "座", "立", "休", "休", "立", "座", "東",
            "東", "休", "休", "立", "座", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "巡", "巡", "巡", "座",
            "座", "座", "巡", "巡", "座", "座", "立", "座", "立", "座", "立", "座", "立", "座", "立", "掃"
          ],
          "外厩門 2": [
            "", "", "", "", "立", "座", "立", "待", "休", "休", "座", "立", "休", "休", "東", "東", "立", "座", "座",
            "立", "東", "東", "休", "休", "座", "座", "休", "座", "座", "座", "巡", "巡", "座", "座", "座", "巡", "巡",
            "巡", "座", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "座", "立", "東", "東", "座", "立"
          ],
          "外厩門 3": [
            "", "", "", "", "準", "立", "座", "立", "座", "立", "休", "休", "立", "座", "座", "休", "東", "東", "休",
            "休", "座", "立", "座", "立", "東", "東", "座", "巡", "巡", "巡", "休", "座", "仮眠", "仮眠", "仮眠", "仮眠",
            "仮眠", "仮眠", "仮眠", "座", "座", "座", "座", "立", "座", "立", "東", "東", "座", "立", "休", ""
          ],
          "外厩門 4": [
            "", "", "", "", "", "", "", "休", "休", "座", "立", "座", "東", "東", "立", "座", "休", "休", "立", "座",
            "立", "座", "東", "東", "巡", "巡", "巡", "巡", "巡", "巡", "座", "", "", "", "", "", "", "", "", "",
            "", "", "", "", "", "", "", "", "", "", "", ""
          ],
          "西通用門 4": [
            "", "", "", "", "準", "立", "座", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "",
            "", "", "", "", "", "座", "座", "座", "座", "休", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠",
            "座", "座", "座", "座", "座", "座", "座", "立", "座", "立", "休", "掃"
          ],
          "西通用門 5": [
            "", "", "", "", "準", "座", "休", "休", "立", "座", "立", "座", "立", "本", "休", "休", "立", "座", "立",
            "座", "休", "休", "本", "座", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "本", "本", "本", "巡",
            "巡", "巡", "座", "座", "座", "座", "巡", "巡", "巡", "巡", "巡", "座", "掃", "待", "立", "座"
          ],
          "西通用門 6": [
            "", "", "", "", "立", "待", "本", "立", "休", "休", "座", "立", "座", "座", "立", "座", "休", "休", "座",
            "立", "座", "立", "座", "立", "座", "座", "座", "休", "本", "座", "座", "座", "巡", "巡", "巡", "本", "本",
            "本", "巡", "巡", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "休", "本", "座", "立"
          ],
          "西通用門 7": [
            "", "", "", "", "座", "休", "立", "座", "座", "立", "休", "休", "本", "立", "座", "立", "座", "立", "休",
            "休", "立", "座", "立", "本", "巡", "巡", "巡", "座", "座", "休", "巡", "巡", "座", "座", "座", "座", "座",
            "座", "本", "本", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "立", "座", "待", "座"
          ]
        },

        // =========================
        // 日曜日（8:00〜20:00：25コ・0〜3は8:00〜9:30の空白）
        // =========================
        sun: {
          "厩舎長": [
            "", "", "", "", "本", "本", "待", "本", "本", "本", "休", "本", "本", "本", "本", "本", "本", "休", "本",
            "本", "本", "本", "本", "本", "本"
          ],
          "外厩門 1": [
            "", "", "", "", "立", "座", "待", "立", "座", "休", "東", "東", "東", "休", "座", "立", "休", "座", "立",
            "座", "座", "座", "座", "座", "座"
          ],
          "外厩門 2": [
            "", "", "", "", "準", "立", "座", "休", "立", "座", "立", "座", "立", "東", "東", "休", "座", "立", "休",
            "東", "東", "座", "座", "東", "東"
          ],
          "外厩門 3": [
            "", "", "", "", "座", "待", "立", "座", "休", "立", "座", "立", "座", "立", "休", "東", "東", "休", "座",
            "立", "座", "東", "東", "座", "座"
          ],
          "外厩門 4": [
            "", "", "", "", "", "", "", "", "", "", "", "", "休", "座", "立", "座", "立", "東", "東", "休", "",
            "", "", "", ""
          ],
          "西通用門 4": [
            "", "", "", "", "準", "立", "座", "休", "立", "座", "立", "座", "休", "", "", "", "", "", "", "休",
            "座", "座", "座", "座", "座"
          ],
          "西通用門 5": [
            "", "", "", "", "立", "座", "立", "座", "待", "立", "座", "休", "立", "座", "立", "座", "座", "本", "立",
            "座", "", "", "", "", ""
          ],
          "西通用門 6": [
            "", "", "", "", "座", "待", "本", "立", "座", "休", "本", "立", "座", "立", "座", "立", "休", "座", "座",
            "立", "", "", "", "", ""
          ]
        }
      };

      // 前回のスロットインデックス
      let prevSlotIndex = null;

      function getSlotCountForDay(day) {
        const table = document.querySelector(`table.schedule-table[data-day="${day}"]`);
        if (!table) return SLOT_COUNTS[day] || 48;
        const headSlots = table.querySelectorAll("thead th[data-slot]").length;
        return headSlots || (SLOT_COUNTS[day] || 48);
      }

      // 場所テーブルのtbody生成
      function buildPlaceTableBodies() {
        ["fri","sat","sun"].forEach(day => {
          const table = document.querySelector(`table.place-table[data-day="${day}"]`);
          if (!table) return;
          const tbody = table.querySelector("tbody");
          tbody.innerHTML = "";
          PLACES.forEach(place => {
            if (day === "sun" && place === "西通用門 7") return;
            const tr = document.createElement("tr");
            tr.dataset.place = place;
            const th = document.createElement("th");
            th.className = "place-cell";
            th.textContent = place; // 後で名前を反映
            tr.appendChild(th);
            tbody.appendChild(tr);
          });
        });
      }

      // スケジュールテーブルのtbody生成
      function buildScheduleBodies() {
        ["fri","sat","sun"].forEach(day => {
          const table = document.querySelector(`table.schedule-table[data-day="${day}"]`);
          if (!table) return;
          const tbody = table.querySelector("tbody");
          tbody.innerHTML = "";
          const slotCount = getSlotCountForDay(day);
          const initForDay = (INITIAL_DATA[day] || {});

          PLACES.forEach(place => {
            if (day === "sun" && place === "西通用門 7") return;
            const tr = document.createElement("tr");
            tr.dataset.place = place;
            const rowInit = initForDay[place] || [];
            for (let i = 0; i < slotCount; i++) {
              const td = document.createElement("td");
              td.dataset.slot = String(i);
              td.className = "slot-cell empty";
              const v = rowInit[i] || "";
              if (v) {
                td.textContent = v;
                applyStateClass(td, v);
              }
              tr.appendChild(td);
            }
            tbody.appendChild(tr);
          });
        });
      }

      // 名前 → 表示文字列（厩舎長だけ1人分）
      function buildPlaceDisplay(day, place) {
        const dayData = namesStore[day] || {};
        const np = dayData[place] || {};
        const n1 = np.n1 || "";
        const n2 = np.n2 || "";
        let baseLabel;

        if (place === "厩舎長") {
          const n = n1 || n2;
          baseLabel = n ? `${n}（${place}）` : place;
        } else {
          let namePart = "";
          if (n1 && n2) namePart = `${n1}・${n2}`;
          else if (n1) namePart = n1;
          else if (n2) namePart = n2;
          baseLabel = namePart ? `${namePart}（${place}）` : place;
        }
        return baseLabel;
      }

      function syncPlaceHeaderForDay(day) {
        const table = document.querySelector(`table.place-table[data-day="${day}"]`);
        if (!table) return;
        table.querySelectorAll("tbody tr").forEach(tr => {
          const place = tr.dataset.place;
          if (!place) return;
          const th = tr.querySelector(".place-cell");
          if (!th) return;
          th.textContent = buildPlaceDisplay(day, place);
        });
      }

      function syncAllPlaceHeaders() {
        ["fri","sat","sun"].forEach(syncPlaceHeaderForDay);
      }

      // 名前パネルは現在使わない（見た目維持のため空実装）
      function buildNamePanels() {
        // names-wrapper は非表示のため、今は何もしない
      }

      function applyStateClass(td, value) {
        td.className = td.className
          .replace(/state-[^\s]+/g, "")
          .replace(/\bempty\b/g,"")
          .trim();
        if (!value) {
          td.classList.add("slot-cell","empty");
        } else {
          td.classList.add("slot-cell","state-" + value);
        }
      }

      // ★ ロータリー関連ユーティリティ
      function getRotaryTarget(day) {
        // 土日とも自日付テーブルに書き込む
        return { targetDay: day };
      }

      function getRotaryBaseSlots(day) {
        // 8:00,8:30,9:00 → slot 0〜2 をロータリー用として使用
        if (day === "sat" || day === "sun") {
          return [0, 1, 2];
        }
        return [];
      }

      function getRotarySetting(day, type) {
        if (day === "sat" || day === "sun") {
          if (type === "up") {
            // ロータリー（↑）: 8:00, 8:30
            return { slots: [0, 1], mark: "ロ↑" };
          }
          if (type === "down") {
            // ロータリー（↓）: 8:30, 9:00
            return { slots: [1, 2], mark: "ロ↓" };
          }
        }
        return { slots: [], mark: "" };
      }

      // ロータリーの選択を適用（up / down / 解除）
      function applyRotarySelection(day, place, value, fromRemote) {
        const baseSlots = getRotaryBaseSlots(day);
        if (!baseSlots.length) return;

        const target = getRotaryTarget(day);
        const table = document.querySelector(`table.schedule-table[data-day="${target.targetDay}"]`);
        if (!table) return;
        const tr = table.querySelector(`tbody tr[data-place="${place}"]`);
        if (!tr) return;

        // まず 8:00〜9:00 の3枠をリセット
        baseSlots.forEach(slotIdx => {
          const td = tr.querySelector(`td[data-slot="${slotIdx}"]`);
          if (!td) return;
          td.textContent = "";
          applyStateClass(td, "");
        });

        // 解除ならここで終了＋Firestore更新
        if (value !== "up" && value !== "down") {
          if (!fromRemote) {
            if (!remoteConfig.rotary[day]) remoteConfig.rotary[day] = {};
            delete remoteConfig.rotary[day][place];
            saveRemoteConfig({ rotary: remoteConfig.rotary });
          }
          return;
        }

        // 新しいロータリー設定を反映
        const cfg = getRotarySetting(day, value);
        const slots = cfg.slots;
        const mark = cfg.mark;
        slots.forEach(slotIdx => {
          const td = tr.querySelector(`td[data-slot="${slotIdx}"]`);
          if (!td) return;
          td.textContent = mark;
          applyStateClass(td, mark);
        });

        if (!fromRemote) {
          if (!remoteConfig.rotary[day]) remoteConfig.rotary[day] = {};
          remoteConfig.rotary[day][place] = value;
          saveRemoteConfig({ rotary: remoteConfig.rotary });
        }
      }

      // Firestore に保存されているロータリー設定を一括適用
      function applyAllRotaryFromRemote() {
        if (!remoteConfig.rotary) return;
        ["sat","sun"].forEach(day => {
          const dayRot = remoteConfig.rotary[day];
          if (!dayRot) return;
          Object.keys(dayRot).forEach(place => {
            const t = dayRot[place];
            if (t === "up" || t === "down") {
              applyRotarySelection(day, place, t, true);
            }
          });
        });
      }

      // ロータリー設定用の小さなメニューを開く（土日共通）
      function openRotaryMenu(day, place, anchorEl) {
        // 既存メニューがあれば消す
        const old = document.getElementById("rotaryMenu");
        if (old && old.parentNode) {
          old.parentNode.removeChild(old);
        }

        const menu = document.createElement("div");
        menu.id = "rotaryMenu";
        menu.className = "rotary-menu";

        const title = document.createElement("div");
        title.className = "rotary-menu-title";
        let dayLabel = day;
        if (day === "sat") dayLabel = "土曜朝";
        else if (day === "sun") dayLabel = "日曜朝";
        title.textContent = `${place} のロータリー設定（${dayLabel}）`;
        menu.appendChild(title);

        const select = document.createElement("select");
        const optNone = document.createElement("option");
        optNone.value = "";
        optNone.textContent = "（ロータリーなし）";
        select.appendChild(optNone);

        const optUp = document.createElement("option");
        optUp.value = "up";
        optUp.textContent = "ロータリー（↑）8:00〜";
        select.appendChild(optUp);

        const optDown = document.createElement("option");
        optDown.value = "down";
        optDown.textContent = "ロータリー（↓）8:30〜";
        select.appendChild(optDown);

        const saved = (remoteConfig.rotary[day] && remoteConfig.rotary[day][place]) || "";
        select.value = saved;

        menu.appendChild(select);
        document.body.appendChild(menu);

        // アンカーの右側あたりに表示
        const rect = anchorEl.getBoundingClientRect();
        menu.style.left = `${rect.right + 8}px`;
        menu.style.top = `${rect.top}px`;

        function closeMenu() {
          if (menu.parentNode) {
            menu.parentNode.removeChild(menu);
          }
        }

        select.addEventListener("change", () => {
          const value = select.value;
          applyRotarySelection(day, place, value, false);
          // ロータリー設定変更後に、各日のヘッダーを更新
          syncPlaceHeaderForDay("sat");
          syncPlaceHeaderForDay("fri");
          syncPlaceHeaderForDay("sun");
          syncAllRowHeights();
          closeMenu();
        });

        // 外側クリックで閉じる
        setTimeout(() => {
          const handler = (ev) => {
            if (!menu.contains(ev.target)) {
              document.removeEventListener("mousedown", handler);
              closeMenu();
            }
          };
          document.addEventListener("mousedown", handler);
        }, 0);
      }

      // 「配置＋名前」セルクリックでロータリーメニューを開く（土日）
      function setupRotaryClickHandlers() {
        ["sat","sun"].forEach(day => {
          const placeTable = document.querySelector(`table.place-table[data-day="${day}"]`);
          if (!placeTable) return;

          placeTable.addEventListener("click", (e) => {
            // 編集モード中のみ有効
            if (!document.body.classList.contains("month-editing")) return;

            const th = e.target.closest(".place-cell");
            if (!th) return;
            const tr = th.parentElement;
            const place = tr.dataset.place || "";
            if (!place) return;

            openRotaryMenu(day, place, th);
          });
        });
      }

      // セルクリック編集は無効化（何もしない）
      function attachCellHandlers() {
        return;
      }

      // ===== 配置テーブルとタイムテーブルの行高さを揃える =====
      function syncRowHeightsForDay(day){
        const placeTable  = document.querySelector(`table.place-table[data-day="${day}"]`);
        const schedTable  = document.querySelector(`table.schedule-table[data-day="${day}"]`);
        if (!placeTable || !schedTable) return;

        const placeRows = placeTable.querySelectorAll("tbody tr");
        const schedRows = schedTable.querySelectorAll("tbody tr");
        const len = Math.min(placeRows.length, schedRows.length);

        for (let i = 0; i < len; i++){
          const pr = placeRows[i];
          const sr = schedRows[i];

          // いったんリセットしてから測る
          pr.style.height = "";
          sr.style.height = "";

          const ph = pr.getBoundingClientRect().height;
          const sh = sr.getBoundingClientRect().height;
          const h  = Math.max(ph, sh);

          pr.style.height = h + "px";
          sr.style.height = h + "px";
        }
      }

      function syncAllRowHeights(){
        ["fri","sat","sun"].forEach(syncRowHeightsForDay);
      }

      // time-head の表示を 01:00 形式に統一
      function normalizeTimeHeaders(){
        document.querySelectorAll(".time-head").forEach(th => {
          const txt = th.textContent.trim();
          const m = txt.match(/^(\d{1,2}):(\d{2})$/);
          if (!m) return;
          let h = m[1];
          const mm = m[2];
          if (h.length === 1) h = "0" + h;
          th.textContent = `${h}:${mm}`;
        });
      }

      // 現在時刻 → スロットindex
      function getCurrentSlotIndex(date, day) {
        const totalMin = date.getHours() * 60 + date.getMinutes();

        let startMin;
        if (day === "fri") {
          // 金曜は 9:30 スタート
          startMin = 9 * 60 + 30;
        } else if (day === "sat" || day === "sun") {
          // 土日はいずれも 8:00 スタート
          startMin = 8 * 60;
        } else {
          startMin = 0;
        }

        const slotCount = getSlotCountForDay(day);

        let diff = totalMin - startMin;
        diff = (diff % (24 * 60) + (24 * 60)) % (24 * 60);

        let idx = Math.floor(diff / 30);
        if (idx < 0) idx = 0;
        if (idx > slotCount - 1) idx = slotCount - 1;
        return idx;
      }

      // 現在時刻の列を「配置」のすぐ右に持ってくる
      function scrollToNowColumn(smooth) {
        if (!daySelect) return;
        let activeDay = daySelect.value;
        // daySelect は YYYY-MM-DD（日付）を持つので、曜日キーに変換
        if (activeDay && activeDay.includes("-")) {
          const d = new Date(activeDay + "T00:00:00");
          if (!isNaN(d.getTime())) {
            const dow = d.getDay();
            if (dow === 5) activeDay = "fri";
            else if (dow === 6) activeDay = "sat";
            else if (dow === 0) activeDay = "sun";
          }
        }
        const wrapper = document.querySelector(`.day-wrapper[data-day="${activeDay}"]`);
        if (!wrapper) return;

        const container = wrapper.querySelector(".table-container");
        const table = wrapper.querySelector("table.schedule-table");
        if (!container || !table) return;

        const target =
          table.querySelector("thead th.now-col") ||
          table.querySelector("tbody td.now-col");
        if (!target) return;

        const targetLeft = target.offsetLeft;
        const margin = 0;

        let desired = targetLeft - margin;
        if (desired < 0) desired = 0;

        const maxScroll = container.scrollWidth - container.clientWidth;
        if (desired > maxScroll) desired = maxScroll;

        container.scrollTo({
          left: desired,
          behavior: smooth ? "smooth" : "auto"
        });
      }

      function updateNowColumn(fromTimer) {
        const now = new Date();
        let activeDay = daySelect.value;
        if (activeDay && activeDay.includes("-")) {
          const d = new Date(activeDay + "T00:00:00");
          if (!isNaN(d.getTime())) {
            const dow = d.getDay();
            if (dow === 5) activeDay = "fri";
            else if (dow === 6) activeDay = "sat";
            else if (dow === 0) activeDay = "sun";
          }
        }
        const idx = getCurrentSlotIndex(now, activeDay);

        const changed = (prevSlotIndex === null || prevSlotIndex !== idx);
        prevSlotIndex = idx;

        document.querySelectorAll("table.schedule-table").forEach(table => {
          const isActive = table.dataset.day === activeDay;
          table.querySelectorAll(".now-col").forEach(el => el.classList.remove("now-col"));
          if (!isActive) return;
          table.querySelectorAll(`[data-slot="${idx}"]`).forEach(el => {
            el.classList.add("now-col");
          });
        });

        const hh = String(now.getHours()).padStart(2,"0");
        const mm = String(now.getMinutes()).padStart(2,"0");
        currentTimeEl.textContent = `現在時刻 ${hh}:${mm}`;

        if (changed) {
          scrollToNowColumn(!!fromTimer);
        }
      }

      function setActiveDay(day) {
        document.querySelectorAll(".day-wrapper").forEach(w => {
          w.classList.toggle("active", w.dataset.day === day);
        });
        document.querySelectorAll(".names-panel").forEach(p => {
          p.classList.toggle("active", p.dataset.day === day);
        });
        prevSlotIndex = null;
        updateNowColumn(false);
        syncRowHeightsForDay(day);
      }

      // ===== 月間シフト（金・土・日） =====
      function getActiveMonthStr() {
        if (!monthPicker) return "";
        let ym = monthPicker.value;
        if (!ym) {
          const now = new Date();
          const m = String(now.getMonth() + 1).padStart(2, "0");
          ym = `${now.getFullYear()}-${m}`;
          monthPicker.value = ym;
        }
        return ym;
      }

      function getFriSatSunDatesForActiveMonth() {
        const ym = getActiveMonthStr();
        if (!ym) return [];
        const [yStr, mStr] = ym.split("-");
        const y = parseInt(yStr, 10);
        const m = parseInt(mStr, 10) - 1;
        const dates = [];
        if (isNaN(y) || isNaN(m)) return dates;
        const d = new Date(y, m, 1);
        const wNames = ["日", "月", "火", "水", "木", "金", "土"];
        while (d.getMonth() === m) {
          const dow = d.getDay(); // 0:日,5:金,6:土
          if (dow === 5 || dow === 6 || dow === 0) {
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, "0");
            const dd = String(d.getDate()).padStart(2, "0");
            const dateStr = `${yyyy}-${mm}-${dd}`;
            const label = `${mm}/${dd}(${wNames[dow]})`;
            const dayKey = (dow === 5 ? "fri" : dow === 6 ? "sat" : "sun");
            dates.push({ dateStr, label, dayKey });
          }
          d.setDate(d.getDate() + 1);
        }
        return dates;
      }

      // 日付プルダウン(daySelect)を、対象月の金土日フル一覧に差し替える
      function rebuildDaySelectForActiveMonth() {
        if (!daySelect) return;
        const infos = getFriSatSunDatesForActiveMonth();
        daySelect.innerHTML = "";
        infos.forEach(info => {
          const opt = document.createElement("option");
          opt.value = info.dateStr; // YYYY-MM-DD
          opt.textContent = info.label; // 例: 12/05(金)
          daySelect.appendChild(opt);
        });
        if (!infos.length) return;

        // 今日が一覧に含まれていればその日を自動選択
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, "0");
        const dd = String(today.getDate()).padStart(2, "0");
        const todayStr = `${yyyy}-${mm}-${dd}`;
        const hasToday = infos.some(info => info.dateStr === todayStr);
        if (hasToday) {
          daySelect.value = todayStr;
        }

        applySelectedDateToSchedule();
      }

      // 指定した日付(YYYY-MM-DD)・曜日キー(fri/sat/sun)に対して、
      // 月間シフトの内容から「配置者の名前」を namesStore に書き込む
      function applyMonthShiftToSchedule(dateStr, dayKey) {
        const rows = loadMonthShiftData();
        if (!rows || !rows.length) return;

        const dateInfos = getFriSatSunDatesForActiveMonth();
        const targetInfo = dateInfos.find(info => info.dateStr === dateStr);
        if (!targetInfo) {
          return;
        }

        // 場所一覧（0:厩舎長, 1以降が他の場所）
        const allPlaces = PLACES.slice();
        const otherPlaces = allPlaces.filter(p => p !== "厩舎長");

        // namesStore の初期化
        if (!namesStore[dayKey]) namesStore[dayKey] = {};
        allPlaces.forEach(place => {
          if (dayKey === "sun" && place === "西通用門 7") return;
          namesStore[dayKey][place] = { n1: "", n2: "" };
        });

        const placeToNames = {};

        // 各行のコードを読み取り、placeToNames に詰める
        const dateStrs = dateInfos.map(d => d.dateStr);

        rows.forEach(row => {
          const rawName = (row.name || "").trim();
          if (!rawName) return;
          const asg = row.assignments || {};
          const code = asg[dateStr];
          if (!code) return;

          if (code === "O" || code === "X") {
            const place = "厩舎長";
            if (!placeToNames[place]) placeToNames[place] = [];
            placeToNames[place].push(rawName);
            return;
          }

          const m = code.match(/^([OXY])(\d)$/);
          if (!m) return;
          const num = parseInt(m[2], 10); // 1〜7
          if (!(num >= 1 && num <= 7)) return;
          const idx = num - 1;

          if (idx < 0 || idx >= otherPlaces.length) return;
          const place = otherPlaces[idx];
          if (!place) return;

          if (!placeToNames[place]) placeToNames[place] = [];
          placeToNames[place].push(rawName);
        });

        // placeToNames → namesStore に反映（最大2人まで）
        Object.keys(placeToNames).forEach(place => {
          const arr = placeToNames[place];
          if (!arr || !arr.length) return;
          const n1 = arr[0];
          const n2 = arr[1];

          if (!namesStore[dayKey]) namesStore[dayKey] = {};
          if (place === "厩舎長") {
            namesStore[dayKey][place] = { n1, n2: "" };
          } else {
            namesStore[dayKey][place] = { n1, n2: n2 || "" };
          }
        });

        // 表示更新
        syncPlaceHeaderForDay(dayKey);
        syncRowHeightsForDay(dayKey);
      }

      // daySelectで選ばれている日付に応じて、表示するシフト(曜日)を切り替える
      function applySelectedDateToSchedule() {
        if (!daySelect || !daySelect.value) return;
        const dateStr = daySelect.value; // YYYY-MM-DD
        const d = new Date(dateStr + "T00:00:00");
        if (isNaN(d.getTime())) return;
        const dow = d.getDay(); // 0〜6
        const dayKey = (dow === 5 ? "fri" : dow === 6 ? "sat" : dow === 0 ? "sun" : null);
        if (!dayKey) return;

        // 月間シフトから、この日付の配置者を各場所に反映
        applyMonthShiftToSchedule(dateStr, dayKey);

        // 対象日の表示を切り替え
        setActiveDay(dayKey);
      }

      function loadMonthShiftData() {
        return currentMonthRows || [];
      }

      function saveMonthShiftTable() {
        if (!monthPicker || !msBody) return;
        const ym = getActiveMonthStr();
        const dateInfos = getFriSatSunDatesForActiveMonth();
        const dateStrs = dateInfos.map(d => d.dateStr);
        const rows = [];

        msBody.querySelectorAll("tr").forEach(tr => {
          const nameInput = tr.querySelector("td.month-shift-name input");
          if (!nameInput) return;
          const name = nameInput.value.trim();
          const assignments = {};
          dateStrs.forEach((ds, idx) => {
            const sel = tr.querySelector(`td[data-col="${idx}"] select`);
            if (!sel) return;
            const v = sel.value;
            if (v) assignments[ds] = v;
          });
          if (!name && Object.keys(assignments).length === 0) return;
          rows.push({ name, assignments });
        });

        currentMonthStr = ym;
        currentMonthRows = rows;
        if (!remoteConfig.monthShifts) remoteConfig.monthShifts = {};
        remoteConfig.monthShifts[ym] = rows;
        saveRemoteConfig({ monthShifts: remoteConfig.monthShifts });
      }

      function appendMonthShiftRow(rowData, dateInfos) {
        if (!msBody) return;
        const tr = document.createElement("tr");

        const nameTd = document.createElement("td");
        nameTd.className = "month-shift-name";
        const nameInput = document.createElement("input");
        nameInput.type = "text";
        nameInput.value = rowData.name || "";
        nameTd.appendChild(nameInput);
        tr.appendChild(nameTd);

        dateInfos.forEach((info, idx) => {
          const td = document.createElement("td");
          td.dataset.col = String(idx);
          const sel = document.createElement("select");

          const addOpt = (val, label) => {
            const o = document.createElement("option");
            o.value = val;
            o.textContent = label;
            sel.appendChild(o);
          };

          addOpt("", "-");
          addOpt("O", "O（厩舎長 当直）");
          addOpt("X", "X（厩舎長 日勤）");
          ["O","X","Y"].forEach(prefix => {
            for (let i = 1; i <= 7; i++) {
              const code = `${prefix}${i}`;
              addOpt(code, code);
            }
          });

          const assigned = (rowData.assignments && rowData.assignments[info.dateStr]) || "";
          sel.value = assigned;

          sel.addEventListener("change", () => {
            saveMonthShiftTable();
          });

          td.appendChild(sel);
          tr.appendChild(td);
        });

        nameInput.addEventListener("input", () => {
          saveMonthShiftTable();
        });

        msBody.appendChild(tr);
      }

      function renderMonthShiftTable() {
        if (!msHeadRow || !msBody) return;
        const dateInfos = getFriSatSunDatesForActiveMonth();

        msHeadRow.innerHTML = "";
        const thName = document.createElement("th");
        thName.textContent = "氏名";
        msHeadRow.appendChild(thName);

        dateInfos.forEach(info => {
          const th = document.createElement("th");
          th.textContent = info.label;
          msHeadRow.appendChild(th);
        });

        msBody.innerHTML = "";

        const rows = loadMonthShiftData();
        if (!rows.length) {
          appendMonthShiftRow({ name: "", assignments: {} }, dateInfos);
        } else {
          rows.forEach(row => appendMonthShiftRow(row, dateInfos));
        }
      }

      document.addEventListener("DOMContentLoaded", async () => {
        buildPlaceTableBodies();
        buildScheduleBodies();
        buildNamePanels();
        attachCellHandlers();
        syncAllPlaceHeaders();
        normalizeTimeHeaders();
        syncAllRowHeights();
        setupRotaryClickHandlers();

        if (editToggle) {
          editToggle.addEventListener("change", () => {
            document.body.classList.toggle("month-editing", editToggle.checked);
          });
        }

        if (daySelect) {
          daySelect.addEventListener("change", () => {
            applySelectedDateToSchedule();
          });
        }

        if (monthPicker) {
          if (!monthPicker.value) {
            const now = new Date();
            const m = String(now.getMonth() + 1).padStart(2, "0");
            monthPicker.value = `${now.getFullYear()}-${m}`;
          }
          monthPicker.addEventListener("change", () => {
            currentMonthStr = getActiveMonthStr();
            currentMonthRows = (remoteConfig.monthShifts && remoteConfig.monthShifts[currentMonthStr]) || [];
            renderMonthShiftTable();
            rebuildDaySelectForActiveMonth();
          });
        }

        if (msAddPerson) {
          msAddPerson.addEventListener("click", () => {
            const infos = getFriSatSunDatesForActiveMonth();
            appendMonthShiftRow({ name: "", assignments: {} }, infos);
            saveMonthShiftTable();
          });
        }

        if (msApplyButton) {
          msApplyButton.addEventListener("click", () => {
            saveMonthShiftTable();
            if (daySelect && daySelect.value) {
              applySelectedDateToSchedule();
            }
            alert("月間シフトを保存しました。");
          });
        }

        // Firestore から設定読み込み
        await loadRemoteConfig();

        if (monthPicker) {
          currentMonthStr = getActiveMonthStr();
          currentMonthRows = (remoteConfig.monthShifts && remoteConfig.monthShifts[currentMonthStr]) || [];
        }

        renderMonthShiftTable();
        rebuildDaySelectForActiveMonth();
        applyAllRotaryFromRemote();

        updateNowColumn(false);
        setInterval(() => updateNowColumn(true), 60000);

        window.addEventListener("resize", () => {
          syncAllRowHeights();
        });
      });
    })();
  </script>
  <script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyCNUZdZeE9t6EFg9tDhSVF2qPcgiyPlrUs",
    authDomain: "cktaizai-c197d.firebaseapp.com",
    projectId: "cktaizai-c197d",
    storageBucket: "cktaizai-c197d.firebasestorage.app",
    messagingSenderId: "434618441616",
    appId: "1:434618441616:web:dd87d2d1f9385b697a9d15",
    measurementId: "G-1BZNEGWFZE"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script>
</body>
</html>
