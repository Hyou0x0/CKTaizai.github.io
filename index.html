<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>中京競馬場 滞在場所特別警備 立座表（新レイアウト）</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "YuGothic", "Yu Gothic", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      color: #333;
    }
    .wrapper {
      padding: 12px;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 8px;
      font-size: 14px;
    }
    .controls label {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    select, input[type="checkbox"] {
      font-size: 14px;
    }
    #currentTime {
      margin-left: auto;
      font-weight: 600;
    }

    /* ===== レイアウト全体（1日分） ===== */
    .day-wrapper {
      margin-top: 8px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
      padding: 8px;
      max-height: 70vh;
      overflow: auto;          /* 縦スクロールは1日ごと */
      display: none;
    }
    .day-wrapper.active {
      display: block;
    }

    .day-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
      padding: 4px 6px;
      background: #2b5fb8;
      color: #fff;
      border-radius: 4px;
    }

    .schedule-main {
      display: flex;
      align-items: flex-start;
      gap: 4px;
    }

    .fixed-col {
      flex: 0 0 150px;  /* 左の配置カラムは固定幅 */
    }

    .scroll-col {
      flex: 1 1 auto;
      min-width: 0;
    }

    .table-container {
      position: relative;
      overflow-x: auto;   /* 横スクロールはここだけ */
      overflow-y: hidden; /* 縦スクロールは day-wrapper に任せる */
    }

    /* ===== テーブル共通 ===== */
    table {
      border-collapse: collapse;
      table-layout: fixed;
      font-size: 12px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 3px 4px;
      text-align: center;
      white-space: nowrap;
    }

    /* 左側：配置のみのテーブル */
    table.place-table {
      width: 100%;
    }
    .place-head {
      background: #f0f3f8;
      font-size: 13px;
      text-align: left;
    }
    th.place-cell {
      background: #fafafa;
      text-align: left;
      line-height: 1.3;
      height: 3em;
      white-space: normal; /* 名前＋（配置）で2行OK */
      font-weight: 600;
    }

    /* 右側：時間スロットのテーブル */
    table.schedule-table {
      min-width: 1200px;
    }

    .schedule-table thead th {
      background: #f0f3f8;
      position: sticky;
      top: 0;
      z-index: 5;
    }
    .schedule-table thead th.time-head {
      font-size: 12px;
    }

    td.slot-cell {
      background: #fff;
    }
    td.empty {
      background: #fff;
    }

    /* 状態ごとの色 */
    td.state-本 { background: #fff; }
    td.state-立 { background: #fff; }
    td.state-座 { background: #fff; }
    td.state-巡 { background: #d8ffd8; }
    td.state-東 { background: #d8e8ff; }
    td.state-仮眠 { background: #e6e6e6; }
    td.state-休 { background: #f9d8d8; }
    td.state-掃 { background: #d8f9ed; }
    td.state-待 { background: #f0e0ff; }
    td.state-準 { background: #e0f0ff; }
    /* ロータリー用（薄い黄色） */
    td.state-ロ↑,
    td.state-ロ↓ { background: #fffbe6; }

    /* ロータリー設定用の小さなポップアップ */
    .rotary-menu {
      position: fixed;
      z-index: 2000;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 6px 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      font-size: 12px;
      max-width: 200px;
    }
    .rotary-menu-title {
      margin-bottom: 4px;
      font-size: 11px;
      color: #555;
      white-space: nowrap;
    }
    .rotary-menu select {
      font-size: 12px;
      width: 100%;
    }

    /* 現在時刻の30分枠 */
    .now-col {
      box-shadow: inset 0 0 0 2px #ff5722;
      background-image: linear-gradient(to bottom, rgba(255,87,34,0.12), rgba(255,87,34,0.02));
    }
    .schedule-table thead th.now-col {
      background: #ff5722;
      color: #fff;
    }

    /* セル編集は無効化（閲覧専用） */
    td[data-slot] {
      cursor: default;
    }
    body.month-editing td[data-slot] {
      outline: none;
    }

    .legend {
      margin-top: 6px;
      font-size: 11px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .legend span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .legend-box {
      width: 14px;
      height: 14px;
      border-radius: 3px;
      border: 1px solid #ccc;
    }
    .legend-box.state-本 { background: #d8f0ff; }
    .legend-box.state-立 { background: #ffe0d8; }
    .legend-box.state-座 { background: #e9ffd8; }
    .legend-box.state-巡 { background: #fff6cc; }
    .legend-box.state-東 { background: #f5d8ff; }
    .legend-box.state-仮眠 { background: #e6e6e6; }
    .legend-box.state-休 { background: #f9d8d8; }
    .legend-box.state-掃 { background: #d8f9ed; }
    .legend-box.state-待 { background: #f0e0ff; }
    .legend-box.state-準 { background: #e0f0ff; }

    /* 名前欄 */
    .names-wrapper {
      margin-top: 10px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
      padding: 8px;
      font-size: 12px;
    }
    .names-panel {
      display: none;
    }
    .names-panel.active {
      display: block;
    }
    .name-line {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      margin-bottom: 4px;
    }
    .name-line-label {
      min-width: 80px;
      font-weight: 600;
    }
    .name-line input {
      font-size: 12px;
      padding: 2px 4px;
      width: 120px;
    }

/* ★ 配置ヘッダーと時間ヘッダーの高さを揃える */
.place-head,
.schedule-table thead th.time-head {
  height: 40px;        /* 好きな値でOK。32〜44ぐらいで調整 */
  line-height: 40px;   /* 縦位置も中央寄せ */
  box-sizing: border-box;
}


    /* 月間シフト編集エリア */
    .month-shift-editor {
      margin-top: 12px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
      padding: 8px;
      font-size: 12px;
      display: none; /* 編集モードのときだけ表示 */
    }
    body.month-editing .month-shift-editor {
      display: block;
    }
    .month-shift-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      font-weight: 600;
    }
    .month-shift-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .month-shift-controls label {
      font-size: 11px;
    }
    .month-shift-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      font-size: 11px;
    }
    .month-shift-table th,
    .month-shift-table td {
      border: 1px solid #ddd;
      padding: 2px;
      text-align: center;
      white-space: nowrap;
    }
    .month-shift-name {
      min-width: 90px;
      text-align: left;
      padding-left: 4px;
    }
    .month-shift-name input {
      width: 100%;
      box-sizing: border-box;
      font-size: 11px;
    }
    .month-shift-table select {
      width: 100%;
      box-sizing: border-box;
      font-size: 11px;
    }
    .month-shift-hint {
      margin-top: 4px;
      font-size: 10px;
      color: #666;
    }


    /* 配置者の手入力欄は現在は使用しないので非表示 */
    .names-wrapper {
      display: none !important;
    }
@media (max-width: 768px) {
      .wrapper {
        padding: 8px;
      }
      table.schedule-table {
        min-width: 900px;
      }
      .fixed-col {
        flex-basis: 130px;
      }
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="controls">
      <label>
        日付:
        <select id="daySelect">
          <option value="fri">金曜 → 土曜</option>
          <option value="sat" selected>土曜 → 日曜</option>
          <option value="sun">日曜 → 終了</option>
        </select>
      </label>
      <label>
        <input type="checkbox" id="editToggle">
        編集モード
      </label>
      <span id="currentTime"></span>
    </div>

    <!-- ===== 金曜 → 土曜 ===== -->
    <div class="day-wrapper" data-day="fri">
      <div class="day-title">滞在場所特別警備 立座表（金曜日＞土曜日・30分刻み）</div>
      <div class="schedule-main">
        <!-- 左：配置＋名前 -->
        <div class="fixed-col">
          <table class="place-table" data-day="fri">
            <thead>
              <tr><th class="place-head">配置</th></tr>
            </thead>
<tbody><tr data-place="厩舎長" style="height: 43px;"><td data-slot="0" class="slot-cell state-本">本</td><td data-slot="1" class="slot-cell state-本">本</td><td data-slot="2" class="slot-cell state-待">待</td><td data-slot="3" class="slot-cell state-本">本</td><td data-slot="4" class="slot-cell state-本">本</td><td data-slot="5" class="slot-cell state-本">本</td><td data-slot="6" class="slot-cell state-本">本</td><td data-slot="7" class="slot-cell state-休">休</td><td data-slot="8" class="slot-cell state-休">休</td><td data-slot="9" class="slot-cell state-本">本</td><td data-slot="10" class="slot-cell state-本">本</td><td data-slot="11" class="slot-cell state-本">本</td><td data-slot="12" class="slot-cell state-本">本</td><td data-slot="13" class="slot-cell state-本">本</td><td data-slot="14" class="slot-cell state-本">本</td><td data-slot="15" class="slot-cell state-本">本</td><td data-slot="16" class="slot-cell state-本">本</td><td data-slot="17" class="slot-cell state-本">本</td><td data-slot="18" class="slot-cell state-本">本</td><td data-slot="19" class="slot-cell state-休">休</td><td data-slot="20" class="slot-cell state-休">休</td><td data-slot="21" class="slot-cell state-本">本</td><td data-slot="22" class="slot-cell state-本">本</td><td data-slot="23" class="slot-cell state-本">本</td><td data-slot="24" class="slot-cell state-本">本</td><td data-slot="25" class="slot-cell state-休">休</td><td data-slot="26" class="slot-cell state-本">本</td><td data-slot="27" class="slot-cell state-本">本</td><td data-slot="28" class="slot-cell state-本 now-col">本</td><td data-slot="29" class="slot-cell state-仮眠">仮眠</td><td data-slot="30" class="slot-cell state-仮眠">仮眠</td><td data-slot="31" class="slot-cell state-仮眠">仮眠</td><td data-slot="32" class="slot-cell state-仮眠">仮眠</td><td data-slot="33" class="slot-cell state-仮眠">仮眠</td><td data-slot="34" class="slot-cell state-仮眠">仮眠</td><td data-slot="35" class="slot-cell state-仮眠">仮眠</td><td data-slot="36" class="slot-cell state-仮眠">仮眠</td><td data-slot="37" class="slot-cell state-本">本</td><td data-slot="38" class="slot-cell state-本">本</td><td data-slot="39" class="slot-cell state-本">本</td><td data-slot="40" class="slot-cell state-本">本</td><td data-slot="41" class="slot-cell state-本">本</td><td data-slot="42" class="slot-cell state-本">本</td><td data-slot="43" class="slot-cell state-本">本</td><td data-slot="44" class="slot-cell state-本">本</td><td data-slot="45" class="slot-cell state-本">本</td><td data-slot="46" class="slot-cell state-本">本</td><td data-slot="47" class="slot-cell state-本">本</td><td data-slot="48" class="slot-cell state-本">本</td></tr><tr data-place="外厩門 1" style="height: 43px;"><td data-slot="0" class="slot-cell state-座">座</td><td data-slot="1" class="slot-cell state-立">立</td><td data-slot="2" class="slot-cell state-待">待</td><td data-slot="3" class="slot-cell state-東">東</td><td data-slot="4" class="slot-cell state-東">東</td><td data-slot="5" class="slot-cell state-休">休</td><td data-slot="6" class="slot-cell state-立">立</td><td data-slot="7" class="slot-cell state-座">座</td><td data-slot="8" class="slot-cell state-立">立</td><td data-slot="9" class="slot-cell state-東">東</td><td data-slot="10" class="slot-cell state-東">東</td><td data-slot="11" class="slot-cell state-休">休</td><td data-slot="12" class="slot-cell state-休">休</td><td data-slot="13" class="slot-cell state-座">座</td><td data-slot="14" class="slot-cell state-立">立</td><td data-slot="15" class="slot-cell state-休">休</td><td data-slot="16" class="slot-cell state-休">休</td><td data-slot="17" class="slot-cell state-東">東</td><td data-slot="18" class="slot-cell state-東">東</td><td data-slot="19" class="slot-cell state-座">座</td><td data-slot="20" class="slot-cell state-座">座</td><td data-slot="21" class="slot-cell state-仮眠">仮眠</td><td data-slot="22" class="slot-cell state-仮眠">仮眠</td><td data-slot="23" class="slot-cell state-仮眠">仮眠</td><td data-slot="24" class="slot-cell state-仮眠">仮眠</td><td data-slot="25" class="slot-cell state-仮眠">仮眠</td><td data-slot="26" class="slot-cell state-仮眠">仮眠</td><td data-slot="27" class="slot-cell state-仮眠">仮眠</td><td data-slot="28" class="slot-cell state-仮眠 now-col">仮眠</td><td data-slot="29" class="slot-cell state-巡">巡</td><td data-slot="30" class="slot-cell state-巡">巡</td><td data-slot="31" class="slot-cell state-巡">巡</td><td data-slot="32" class="slot-cell state-座">座</td><td data-slot="33" class="slot-cell state-座">座</td><td data-slot="34" class="slot-cell state-座">座</td><td data-slot="35" class="slot-cell state-巡">巡</td><td data-slot="36" class="slot-cell state-巡">巡</td><td data-slot="37" class="slot-cell state-巡">巡</td><td data-slot="38" class="slot-cell state-座">座</td><td data-slot="39" class="slot-cell state-立">立</td><td data-slot="40" class="slot-cell state-座">座</td><td data-slot="41" class="slot-cell state-立">立</td><td data-slot="42" class="slot-cell state-座">座</td><td data-slot="43" class="slot-cell state-立">立</td><td data-slot="44" class="slot-cell state-座">座</td><td data-slot="45" class="slot-cell state-座">座</td><td data-slot="46" class="slot-cell state-立">立</td><td data-slot="47" class="slot-cell state-座">座</td><td data-slot="48" class="slot-cell state-掃">掃</td></tr><tr data-place="外厩門 2" style="height: 43px;"><td data-slot="0" class="slot-cell state-座">座</td><td data-slot="1" class="slot-cell state-座">座</td><td data-slot="2" class="slot-cell state-待">待</td><td data-slot="3" class="slot-cell state-立">立</td><td data-slot="4" class="slot-cell state-座">座</td><td data-slot="5" class="slot-cell state-東">東</td><td data-slot="6" class="slot-cell state-東">東</td><td data-slot="7" class="slot-cell state-休">休</td><td data-slot="8" class="slot-cell state-休">休</td><td data-slot="9" class="slot-cell state-座">座</td><td data-slot="10" class="slot-cell state-立">立</td><td data-slot="11" class="slot-cell state-座">座</td><td data-slot="12" class="slot-cell state-立">立</td><td data-slot="13" class="slot-cell state-東">東</td><td data-slot="14" class="slot-cell state-東">東</td><td data-slot="15" class="slot-cell state-座">座</td><td data-slot="16" class="slot-cell state-立">立</td><td data-slot="17" class="slot-cell state-座">座</td><td data-slot="18" class="slot-cell state-立">立</td><td data-slot="19" class="slot-cell state-休">休</td><td data-slot="20" class="slot-cell state-休">休</td><td data-slot="21" class="slot-cell state-座">座</td><td data-slot="22" class="slot-cell state-座">座</td><td data-slot="23" class="slot-cell state-休">休</td><td data-slot="24" class="slot-cell state-巡">巡</td><td data-slot="25" class="slot-cell state-巡">巡</td><td data-slot="26" class="slot-cell state-巡">巡</td><td data-slot="27" class="slot-cell state-座">座</td><td data-slot="28" class="slot-cell state-座 now-col">座</td><td data-slot="29" class="slot-cell state-座">座</td><td data-slot="30" class="slot-cell state-座">座</td><td data-slot="31" class="slot-cell state-座">座</td><td data-slot="32" class="slot-cell state-巡">巡</td><td data-slot="33" class="slot-cell state-巡">巡</td><td data-slot="34" class="slot-cell state-巡">巡</td><td data-slot="35" class="slot-cell state-座">座</td><td data-slot="36" class="slot-cell state-仮眠">仮眠</td><td data-slot="37" class="slot-cell state-仮眠">仮眠</td><td data-slot="38" class="slot-cell state-仮眠">仮眠</td><td data-slot="39" class="slot-cell state-仮眠">仮眠</td><td data-slot="40" class="slot-cell state-仮眠">仮眠</td><td data-slot="41" class="slot-cell state-仮眠">仮眠</td><td data-slot="42" class="slot-cell state-仮眠">仮眠</td><td data-slot="43" class="slot-cell state-座">座</td><td data-slot="44" class="slot-cell state-立">立</td><td data-slot="45" class="slot-cell state-東">東</td><td data-slot="46" class="slot-cell state-東">東</td><td data-slot="47" class="slot-cell state-休">休</td><td data-slot="48" class="slot-cell state-立">立</td></tr><tr data-place="外厩門 3" style="height: 43px;"><td data-slot="0" class="slot-cell state-立">立</td><td data-slot="1" class="slot-cell state-待">待</td><td data-slot="2" class="slot-cell state-立">立</td><td data-slot="3" class="slot-cell state-座">座</td><td data-slot="4" class="slot-cell state-立">立</td><td data-slot="5" class="slot-cell state-座">座</td><td data-slot="6" class="slot-cell state-休">休</td><td data-slot="7" class="slot-cell state-立">立</td><td data-slot="8" class="slot-cell state-座">座</td><td data-slot="9" class="slot-cell state-休">休</td><td data-slot="10" class="slot-cell state-休">休</td><td data-slot="11" class="slot-cell state-立">立</td><td data-slot="12" class="slot-cell state-座">座</td><td data-slot="13" class="slot-cell state-立">立</td><td data-slot="14" class="slot-cell state-座">座</td><td data-slot="15" class="slot-cell state-東">東</td><td data-slot="16" class="slot-cell state-東">東</td><td data-slot="17" class="slot-cell state-休">休</td><td data-slot="18" class="slot-cell state-休">休</td><td data-slot="19" class="slot-cell state-座">座</td><td data-slot="20" class="slot-cell state-座">座</td><td data-slot="21" class="slot-cell state-東">東</td><td data-slot="22" class="slot-cell state-東">東</td><td data-slot="23" class="slot-cell state-座">座</td><td data-slot="24" class="slot-cell state-座">座</td><td data-slot="25" class="slot-cell state-座">座</td><td data-slot="26" class="slot-cell state-座">座</td><td data-slot="27" class="slot-cell state-巡">巡</td><td data-slot="28" class="slot-cell state-巡 now-col">巡</td><td data-slot="29" class="slot-cell state-仮眠">仮眠</td><td data-slot="30" class="slot-cell state-仮眠">仮眠</td><td data-slot="31" class="slot-cell state-仮眠">仮眠</td><td data-slot="32" class="slot-cell state-仮眠">仮眠</td><td data-slot="33" class="slot-cell state-仮眠">仮眠</td><td data-slot="34" class="slot-cell state-仮眠">仮眠</td><td data-slot="35" class="slot-cell state-仮眠">仮眠</td><td data-slot="36" class="slot-cell state-座">座</td><td data-slot="37" class="slot-cell state-座">座</td><td data-slot="38" class="slot-cell state-座">座</td><td data-slot="39" class="slot-cell state-座">座</td><td data-slot="40" class="slot-cell state-立">立</td><td data-slot="41" class="slot-cell state-座">座</td><td data-slot="42" class="slot-cell state-立">立</td><td data-slot="43" class="slot-cell state-東">東</td><td data-slot="44" class="slot-cell state-東">東</td><td data-slot="45" class="slot-cell state-立">立</td><td data-slot="46" class="slot-cell state-座">座</td><td data-slot="47" class="slot-cell state-立">立</td><td data-slot="48" class="slot-cell state-座">座</td></tr><tr data-place="外厩門 4" style="height: 43px;"><td data-slot="0" class="slot-cell state-座">座</td><td data-slot="1" class="slot-cell state-待">待</td><td data-slot="2" class="slot-cell state-座">座</td><td data-slot="3" class="slot-cell state-休">休</td><td data-slot="4" class="slot-cell state-休">休</td><td data-slot="5" class="slot-cell state-立">立</td><td data-slot="6" class="slot-cell state-座">座</td><td data-slot="7" class="slot-cell state-東">東</td><td data-slot="8" class="slot-cell state-東">東</td><td data-slot="9" class="slot-cell state-立">立</td><td data-slot="10" class="slot-cell state-座">座</td><td data-slot="11" class="slot-cell state-東">東</td><td data-slot="12" class="slot-cell state-東">東</td><td data-slot="13" class="slot-cell state-休">休</td><td data-slot="14" class="slot-cell state-休">休</td><td data-slot="15" class="slot-cell state-立">立</td><td data-slot="16" class="slot-cell state-座">座</td><td data-slot="17" class="slot-cell state-座">座</td><td data-slot="18" class="slot-cell state-座">座</td><td data-slot="19" class="slot-cell state-東">東</td><td data-slot="20" class="slot-cell state-東">東</td><td data-slot="21" class="slot-cell state-巡">巡</td><td data-slot="22" class="slot-cell state-巡">巡</td><td data-slot="23" class="slot-cell state-巡">巡</td><td data-slot="24" class="slot-cell empty"></td><td data-slot="25" class="slot-cell empty"></td><td data-slot="26" class="slot-cell empty"></td><td data-slot="27" class="slot-cell empty"></td><td data-slot="28" class="slot-cell empty now-col"></td><td data-slot="29" class="slot-cell empty"></td><td data-slot="30" class="slot-cell empty"></td><td data-slot="31" class="slot-cell empty"></td><td data-slot="32" class="slot-cell empty"></td><td data-slot="33" class="slot-cell empty"></td><td data-slot="34" class="slot-cell empty"></td><td data-slot="35" class="slot-cell empty"></td><td data-slot="36" class="slot-cell empty"></td><td data-slot="37" class="slot-cell empty"></td><td data-slot="38" class="slot-cell empty"></td><td data-slot="39" class="slot-cell empty"></td><td data-slot="40" class="slot-cell empty"></td><td data-slot="41" class="slot-cell empty"></td><td data-slot="42" class="slot-cell empty"></td><td data-slot="43" class="slot-cell empty"></td><td data-slot="44" class="slot-cell empty"></td><td data-slot="45" class="slot-cell empty"></td><td data-slot="46" class="slot-cell empty"></td><td data-slot="47" class="slot-cell empty"></td><td data-slot="48" class="slot-cell empty"></td></tr><tr data-place="西通用門 4" style="height: 43px;"><td data-slot="0" class="slot-cell empty"></td><td data-slot="1" class="slot-cell empty"></td><td data-slot="2" class="slot-cell empty"></td><td data-slot="3" class="slot-cell empty"></td><td data-slot="4" class="slot-cell empty"></td><td data-slot="5" class="slot-cell empty"></td><td data-slot="6" class="slot-cell empty"></td><td data-slot="7" class="slot-cell empty"></td><td data-slot="8" class="slot-cell empty"></td><td data-slot="9" class="slot-cell empty"></td><td data-slot="10" class="slot-cell empty"></td><td data-slot="11" class="slot-cell empty"></td><td data-slot="12" class="slot-cell empty"></td><td data-slot="13" class="slot-cell empty"></td><td data-slot="14" class="slot-cell empty"></td><td data-slot="15" class="slot-cell empty"></td><td data-slot="16" class="slot-cell empty"></td><td data-slot="17" class="slot-cell empty"></td><td data-slot="18" class="slot-cell empty"></td><td data-slot="19" class="slot-cell empty"></td><td data-slot="20" class="slot-cell empty"></td><td data-slot="21" class="slot-cell empty"></td><td data-slot="22" class="slot-cell empty"></td><td data-slot="23" class="slot-cell empty"></td><td data-slot="24" class="slot-cell state-座">座</td><td data-slot="25" class="slot-cell state-座">座</td><td data-slot="26" class="slot-cell state-座">座</td><td data-slot="27" class="slot-cell state-座">座</td><td data-slot="28" class="slot-cell state-休 now-col">休</td><td data-slot="29" class="slot-cell state-仮眠">仮眠</td><td data-slot="30" class="slot-cell state-仮眠">仮眠</td><td data-slot="31" class="slot-cell state-仮眠">仮眠</td><td data-slot="32" class="slot-cell state-仮眠">仮眠</td><td data-slot="33" class="slot-cell state-仮眠">仮眠</td><td data-slot="34" class="slot-cell state-仮眠">仮眠</td><td data-slot="35" class="slot-cell state-仮眠">仮眠</td><td data-slot="36" class="slot-cell state-仮眠">仮眠</td><td data-slot="37" class="slot-cell state-座">座</td><td data-slot="38" class="slot-cell state-巡">巡</td><td data-slot="39" class="slot-cell state-巡">巡</td><td data-slot="40" class="slot-cell state-巡">巡</td><td data-slot="41" class="slot-cell state-巡">巡</td><td data-slot="42" class="slot-cell state-座">座</td><td data-slot="43" class="slot-cell state-立">立</td><td data-slot="44" class="slot-cell state-座">座</td><td data-slot="45" class="slot-cell state-立">立</td><td data-slot="46" class="slot-cell state-掃">掃</td><td data-slot="47" class="slot-cell state-休">休</td><td data-slot="48" class="slot-cell state-座">座</td></tr><tr data-place="西通用門 5" style="height: 43px;"><td data-slot="0" class="slot-cell state-立">立</td><td data-slot="1" class="slot-cell state-待">待</td><td data-slot="2" class="slot-cell state-座">座</td><td data-slot="3" class="slot-cell state-休">休</td><td data-slot="4" class="slot-cell state-休">休</td><td data-slot="5" class="slot-cell state-立">立</td><td data-slot="6" class="slot-cell state-座">座</td><td data-slot="7" class="slot-cell state-本">本</td><td data-slot="8" class="slot-cell state-本">本</td><td data-slot="9" class="slot-cell state-立">立</td><td data-slot="10" class="slot-cell state-座">座</td><td data-slot="11" class="slot-cell state-休">休</td><td data-slot="12" class="slot-cell state-立">立</td><td data-slot="13" class="slot-cell state-座">座</td><td data-slot="14" class="slot-cell state-立">立</td><td data-slot="15" class="slot-cell state-休">休</td><td data-slot="16" class="slot-cell state-休">休</td><td data-slot="17" class="slot-cell state-座">座</td><td data-slot="18" class="slot-cell state-座">座</td><td data-slot="19" class="slot-cell state-座">座</td><td data-slot="20" class="slot-cell state-座">座</td><td data-slot="21" class="slot-cell state-仮眠">仮眠</td><td data-slot="22" class="slot-cell state-仮眠">仮眠</td><td data-slot="23" class="slot-cell state-仮眠">仮眠</td><td data-slot="24" class="slot-cell state-仮眠">仮眠</td><td data-slot="25" class="slot-cell state-仮眠">仮眠</td><td data-slot="26" class="slot-cell state-仮眠">仮眠</td><td data-slot="27" class="slot-cell state-仮眠">仮眠</td><td data-slot="28" class="slot-cell state-仮眠 now-col">仮眠</td><td data-slot="29" class="slot-cell state-座">座</td><td data-slot="30" class="slot-cell state-座">座</td><td data-slot="31" class="slot-cell state-座">座</td><td data-slot="32" class="slot-cell state-本">本</td><td data-slot="33" class="slot-cell state-本">本</td><td data-slot="34" class="slot-cell state-本">本</td><td data-slot="35" class="slot-cell state-巡">巡</td><td data-slot="36" class="slot-cell state-巡">巡</td><td data-slot="37" class="slot-cell state-巡">巡</td><td data-slot="38" class="slot-cell state-座">座</td><td data-slot="39" class="slot-cell state-座">座</td><td data-slot="40" class="slot-cell state-座">座</td><td data-slot="41" class="slot-cell state-座">座</td><td data-slot="42" class="slot-cell state-立">立</td><td data-slot="43" class="slot-cell state-座">座</td><td data-slot="44" class="slot-cell state-立">立</td><td data-slot="45" class="slot-cell state-休">休</td><td data-slot="46" class="slot-cell state-座">座</td><td data-slot="47" class="slot-cell state-立">立</td><td data-slot="48" class="slot-cell state-掃">掃</td></tr><tr data-place="西通用門 6" style="height: 43px;"><td data-slot="0" class="slot-cell state-座">座</td><td data-slot="1" class="slot-cell state-立">立</td><td data-slot="2" class="slot-cell state-本">本</td><td data-slot="3" class="slot-cell state-立">立</td><td data-slot="4" class="slot-cell state-座">座</td><td data-slot="5" class="slot-cell state-休">休</td><td data-slot="6" class="slot-cell state-立">立</td><td data-slot="7" class="slot-cell state-座">座</td><td data-slot="8" class="slot-cell state-立">立</td><td data-slot="9" class="slot-cell state-座">座</td><td data-slot="10" class="slot-cell state-立">立</td><td data-slot="11" class="slot-cell state-座">座</td><td data-slot="12" class="slot-cell state-休">休</td><td data-slot="13" class="slot-cell state-休">休</td><td data-slot="14" class="slot-cell state-座">座</td><td data-slot="15" class="slot-cell state-立">立</td><td data-slot="16" class="slot-cell state-座">座</td><td data-slot="17" class="slot-cell state-休">休</td><td data-slot="18" class="slot-cell state-座">座</td><td data-slot="19" class="slot-cell state-座">座</td><td data-slot="20" class="slot-cell state-座">座</td><td data-slot="21" class="slot-cell state-巡">巡</td><td data-slot="22" class="slot-cell state-巡">巡</td><td data-slot="23" class="slot-cell state-巡">巡</td><td data-slot="24" class="slot-cell state-休">休</td><td data-slot="25" class="slot-cell state-座">座</td><td data-slot="26" class="slot-cell state-座">座</td><td data-slot="27" class="slot-cell state-巡">巡</td><td data-slot="28" class="slot-cell state-巡 now-col">巡</td><td data-slot="29" class="slot-cell state-本">本</td><td data-slot="30" class="slot-cell state-本">本</td><td data-slot="31" class="slot-cell state-本">本</td><td data-slot="32" class="slot-cell state-巡">巡</td><td data-slot="33" class="slot-cell state-巡">巡</td><td data-slot="34" class="slot-cell state-巡">巡</td><td data-slot="35" class="slot-cell state-座">座</td><td data-slot="36" class="slot-cell state-座">座</td><td data-slot="37" class="slot-cell state-仮眠">仮眠</td><td data-slot="38" class="slot-cell state-仮眠">仮眠</td><td data-slot="39" class="slot-cell state-仮眠">仮眠</td><td data-slot="40" class="slot-cell state-仮眠">仮眠</td><td data-slot="41" class="slot-cell state-仮眠">仮眠</td><td data-slot="42" class="slot-cell state-仮眠">仮眠</td><td data-slot="43" class="slot-cell state-仮眠">仮眠</td><td data-slot="44" class="slot-cell state-仮眠">仮眠</td><td data-slot="45" class="slot-cell state-待">待</td><td data-slot="46" class="slot-cell state-休">休</td><td data-slot="47" class="slot-cell state-座">座</td><td data-slot="48" class="slot-cell state-立">立</td></tr><tr data-place="西通用門 7" style="height: 43px;"><td data-slot="0" class="slot-cell state-座">座</td><td data-slot="1" class="slot-cell state-座">座</td><td data-slot="2" class="slot-cell state-立">立</td><td data-slot="3" class="slot-cell state-座">座</td><td data-slot="4" class="slot-cell state-立">立</td><td data-slot="5" class="slot-cell state-座">座</td><td data-slot="6" class="slot-cell state-待">待</td><td data-slot="7" class="slot-cell state-立">立</td><td data-slot="8" class="slot-cell state-座">座</td><td data-slot="9" class="slot-cell state-休">休</td><td data-slot="10" class="slot-cell state-休">休</td><td data-slot="11" class="slot-cell state-立">立</td><td data-slot="12" class="slot-cell state-座">座</td><td data-slot="13" class="slot-cell state-立">立</td><td data-slot="14" class="slot-cell state-待">待</td><td data-slot="15" class="slot-cell state-座">座</td><td data-slot="16" class="slot-cell state-立">立</td><td data-slot="17" class="slot-cell state-座">座</td><td data-slot="18" class="slot-cell state-休">休</td><td data-slot="19" class="slot-cell state-本">本</td><td data-slot="20" class="slot-cell state-本">本</td><td data-slot="21" class="slot-cell state-座">座</td><td data-slot="22" class="slot-cell state-座">座</td><td data-slot="23" class="slot-cell state-座">座</td><td data-slot="24" class="slot-cell state-巡">巡</td><td data-slot="25" class="slot-cell state-巡">巡</td><td data-slot="26" class="slot-cell state-巡">巡</td><td data-slot="27" class="slot-cell state-休">休</td><td data-slot="28" class="slot-cell state-座 now-col">座</td><td data-slot="29" class="slot-cell state-巡">巡</td><td data-slot="30" class="slot-cell state-巡">巡</td><td data-slot="31" class="slot-cell state-巡">巡</td><td data-slot="32" class="slot-cell state-座">座</td><td data-slot="33" class="slot-cell state-座">座</td><td data-slot="34" class="slot-cell state-座">座</td><td data-slot="35" class="slot-cell state-本">本</td><td data-slot="36" class="slot-cell state-本">本</td><td data-slot="37" class="slot-cell state-仮眠">仮眠</td><td data-slot="38" class="slot-cell state-仮眠">仮眠</td><td data-slot="39" class="slot-cell state-仮眠">仮眠</td><td data-slot="40" class="slot-cell state-仮眠">仮眠</td><td data-slot="41" class="slot-cell state-仮眠">仮眠</td><td data-slot="42" class="slot-cell state-仮眠">仮眠</td><td data-slot="43" class="slot-cell state-仮眠">仮眠</td><td data-slot="44" class="slot-cell state-仮眠">仮眠</td><td data-slot="45" class="slot-cell state-座">座</td><td data-slot="46" class="slot-cell state-立">立</td><td data-slot="47" class="slot-cell state-休">休</td><td data-slot="48" class="slot-cell state-座">座</td></tr></tbody>
          </table>
        </div>
        <!-- 右：時間スロット -->
        <div class="scroll-col">
          <div class="table-container">
            <table class="schedule-table" data-day="fri">
              <thead>
                <tr>
                  <th class="time-head" data-slot="0">9:30</th>
                  <th class="time-head" data-slot="1">10:00</th>
                  <th class="time-head" data-slot="2">10:30</th>
                  <th class="time-head" data-slot="3">11:00</th>
                  <th class="time-head" data-slot="4">11:30</th>
                  <th class="time-head" data-slot="5">12:00</th>
                  <th class="time-head" data-slot="6">12:30</th>
                  <th class="time-head" data-slot="7">13:00</th>
                  <th class="time-head" data-slot="8">13:30</th>
                  <th class="time-head" data-slot="9">14:00</th>
                  <th class="time-head" data-slot="10">14:30</th>
                  <th class="time-head" data-slot="11">15:00</th>
                  <th class="time-head" data-slot="12">15:30</th>
                  <th class="time-head" data-slot="13">16:00</th>
                  <th class="time-head" data-slot="14">16:30</th>
                  <th class="time-head" data-slot="15">17:00</th>
                  <th class="time-head" data-slot="16">17:30</th>
                  <th class="time-head" data-slot="17">18:00</th>
                  <th class="time-head" data-slot="18">18:30</th>
                  <th class="time-head" data-slot="19">19:00</th>
                  <th class="time-head" data-slot="20">19:30</th>
                  <th class="time-head" data-slot="21">20:00</th>
                  <th class="time-head" data-slot="22">20:30</th>
                  <th class="time-head" data-slot="23">21:00</th>
                  <th class="time-head" data-slot="24">21:30</th>
                  <th class="time-head" data-slot="25">22:00</th>
                  <th class="time-head" data-slot="26">22:30</th>
                  <th class="time-head" data-slot="27">23:00</th>
                  <th class="time-head" data-slot="28">23:30</th>
                  <th class="time-head" data-slot="29">24:00</th>
                  <th class="time-head" data-slot="30">24:30</th>
                  <th class="time-head" data-slot="31">1:00</th>
                  <th class="time-head" data-slot="32">1:30</th>
                  <th class="time-head" data-slot="33">2:00</th>
                  <th class="time-head" data-slot="34">2:30</th>
                  <th class="time-head" data-slot="35">3:00</th>
                  <th class="time-head" data-slot="36">3:30</th>
                  <th class="time-head" data-slot="37">4:00</th>
                  <th class="time-head" data-slot="38">4:30</th>
                  <th class="time-head" data-slot="39">5:00</th>
                  <th class="time-head" data-slot="40">5:30</th>
                  <th class="time-head" data-slot="41">6:00</th>
                  <th class="time-head" data-slot="42">6:30</th>
                  <th class="time-head" data-slot="43">7:00</th>
                  <th class="time-head" data-slot="44">7:30</th>
                  <th class="time-head" data-slot="45">8:00</th>
                  <th class="time-head" data-slot="46">8:30</th>
                  <th class="time-head" data-slot="47">9:00</th>
                  <th class="time-head" data-slot="48">9:30</th>
                </tr>
              </thead>
              <tbody>
                <!-- JSで行を生成 -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== 土曜 → 日曜 ===== -->
    <div class="day-wrapper" data-day="sat">
      <div class="day-title">滞在場所特別警備 立座表（土曜日＞日曜日・30分刻み）</div>
      <div class="schedule-main">
        <div class="fixed-col">
          <table class="place-table" data-day="sat">
            <thead>
              <tr><th class="place-head">配置</th></tr>
            </thead>
            <tbody>
              <!-- JSで行を生成 -->
            </tbody>
          </table>
        </div>
        <div class="scroll-col">
          <div class="table-container">
            <table class="schedule-table" data-day="sat">
              <thead>
                <tr>
                  <th class="time-head" data-slot="0">8:00</th>
                  <th class="time-head" data-slot="1">8:30</th>
                  <th class="time-head" data-slot="2">9:00</th>
                  <th class="time-head" data-slot="3">9:30</th>
                  <th class="time-head" data-slot="4">10:00</th>
                  <th class="time-head" data-slot="5">10:30</th>
                  <th class="time-head" data-slot="6">11:00</th>
                  <th class="time-head" data-slot="7">11:30</th>
                  <th class="time-head" data-slot="8">12:00</th>
                  <th class="time-head" data-slot="9">12:30</th>
                  <th class="time-head" data-slot="10">13:00</th>
                  <th class="time-head" data-slot="11">13:30</th>
                  <th class="time-head" data-slot="12">14:00</th>
                  <th class="time-head" data-slot="13">14:30</th>
                  <th class="time-head" data-slot="14">15:00</th>
                  <th class="time-head" data-slot="15">15:30</th>
                  <th class="time-head" data-slot="16">16:00</th>
                  <th class="time-head" data-slot="17">16:30</th>
                  <th class="time-head" data-slot="18">17:00</th>
                  <th class="time-head" data-slot="19">17:30</th>
                  <th class="time-head" data-slot="20">18:00</th>
                  <th class="time-head" data-slot="21">18:30</th>
                  <th class="time-head" data-slot="22">19:00</th>
                  <th class="time-head" data-slot="23">19:30</th>
                  <th class="time-head" data-slot="24">20:00</th>
                  <th class="time-head" data-slot="25">20:30</th>
                  <th class="time-head" data-slot="26">21:00</th>
                  <th class="time-head" data-slot="27">21:30</th>
                  <th class="time-head" data-slot="28">22:00</th>
                  <th class="time-head" data-slot="29">22:30</th>
                  <th class="time-head" data-slot="30">23:00</th>
                  <th class="time-head" data-slot="31">23:30</th>
                  <th class="time-head" data-slot="32">0:00</th>
                  <th class="time-head" data-slot="33">0:30</th>
                  <th class="time-head" data-slot="34">1:00</th>
                  <th class="time-head" data-slot="35">1:30</th>
                  <th class="time-head" data-slot="36">2:00</th>
                  <th class="time-head" data-slot="37">2:30</th>
                  <th class="time-head" data-slot="38">3:00</th>
                  <th class="time-head" data-slot="39">3:30</th>
                  <th class="time-head" data-slot="40">4:00</th>
                  <th class="time-head" data-slot="41">4:30</th>
                  <th class="time-head" data-slot="42">5:00</th>
                  <th class="time-head" data-slot="43">5:30</th>
                  <th class="time-head" data-slot="44">6:00</th>
                  <th class="time-head" data-slot="45">6:30</th>
                  <th class="time-head" data-slot="46">7:00</th>
                  <th class="time-head" data-slot="47">7:30</th>
                  <th class="time-head" data-slot="48">8:00</th>
                  <th class="time-head" data-slot="49">8:30</th>
                  <th class="time-head" data-slot="50">9:00</th>
                  <th class="time-head" data-slot="51">9:30</th>
                </tr>
              </thead>
              <tbody>
                <!-- JSで行を生成（初期値は土曜用データから埋める） -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== 日曜 → 終了 ===== -->
    <div class="day-wrapper" data-day="sun">
      <div class="day-title">滞在場所特別警備 立座表（日曜日＞終了・30分刻み）</div>
      <div class="schedule-main">
        <div class="fixed-col">
          <table class="place-table" data-day="sun">
            <thead>
              <tr><th class="place-head">配置</th></tr>
            </thead>
            <tbody>
              <!-- JSで行を生成 -->
            </tbody>
          </table>
        </div>
        <div class="scroll-col">
          <div class="table-container">
            <table class="schedule-table" data-day="sun">
              <thead>
                <tr>
                  <th class="time-head" data-slot="0">8:00</th>
                  <th class="time-head" data-slot="1">8:30</th>
                  <th class="time-head" data-slot="2">9:00</th>
                  <th class="time-head" data-slot="3">9:30</th>
                  <th class="time-head" data-slot="4">10:00</th>
                  <th class="time-head" data-slot="5">10:30</th>
                  <th class="time-head" data-slot="6">11:00</th>
                  <th class="time-head" data-slot="7">11:30</th>
                  <th class="time-head" data-slot="8">12:00</th>
                  <th class="time-head" data-slot="9">12:30</th>
                  <th class="time-head" data-slot="10">13:00</th>
                  <th class="time-head" data-slot="11">13:30</th>
                  <th class="time-head" data-slot="12">14:00</th>
                  <th class="time-head" data-slot="13">14:30</th>
                  <th class="time-head" data-slot="14">15:00</th>
                  <th class="time-head" data-slot="15">15:30</th>
                  <th class="time-head" data-slot="16">16:00</th>
                  <th class="time-head" data-slot="17">16:30</th>
                  <th class="time-head" data-slot="18">17:00</th>
                  <th class="time-head" data-slot="19">17:30</th>
                  <th class="time-head" data-slot="20">18:00</th>
                  <th class="time-head" data-slot="21">18:30</th>
                  <th class="time-head" data-slot="22">19:00</th>
                  <th class="time-head" data-slot="23">19:30</th>
                  <th class="time-head" data-slot="24">20:00</th>
                </tr>
              </thead>
<tbody><tr data-place="厩舎長" style="height: 43px;"><td data-slot="0" class="slot-cell state-本">本</td><td data-slot="1" class="slot-cell state-本">本</td><td data-slot="2" class="slot-cell state-待">待</td><td data-slot="3" class="slot-cell state-本">本</td><td data-slot="4" class="slot-cell state-本">本</td><td data-slot="5" class="slot-cell state-本">本</td><td data-slot="6" class="slot-cell state-休">休</td><td data-slot="7" class="slot-cell state-本">本</td><td data-slot="8" class="slot-cell state-本">本</td><td data-slot="9" class="slot-cell state-本">本</td><td data-slot="10" class="slot-cell state-本">本</td><td data-slot="11" class="slot-cell state-本">本</td><td data-slot="12" class="slot-cell state-本">本</td><td data-slot="13" class="slot-cell state-休">休</td><td data-slot="14" class="slot-cell state-本">本</td><td data-slot="15" class="slot-cell state-本">本</td><td data-slot="16" class="slot-cell state-本">本</td><td data-slot="17" class="slot-cell state-本">本</td><td data-slot="18" class="slot-cell state-本">本</td><td data-slot="19" class="slot-cell state-本">本</td><td data-slot="20" class="slot-cell state-本">本</td></tr><tr data-place="外厩門 1" style="height: 43px;"><td data-slot="0" class="slot-cell state-立">立</td><td data-slot="1" class="slot-cell state-座">座</td><td data-slot="2" class="slot-cell state-待">待</td><td data-slot="3" class="slot-cell state-立">立</td><td data-slot="4" class="slot-cell state-座">座</td><td data-slot="5" class="slot-cell state-休">休</td><td data-slot="6" class="slot-cell state-東">東</td><td data-slot="7" class="slot-cell state-東">東</td><td data-slot="8" class="slot-cell state-東">東</td><td data-slot="9" class="slot-cell state-休">休</td><td data-slot="10" class="slot-cell state-座">座</td><td data-slot="11" class="slot-cell state-立">立</td><td data-slot="12" class="slot-cell state-休">休</td><td data-slot="13" class="slot-cell state-座">座</td><td data-slot="14" class="slot-cell state-立">立</td><td data-slot="15" class="slot-cell state-座">座</td><td data-slot="16" class="slot-cell state-座">座</td><td data-slot="17" class="slot-cell state-座">座</td><td data-slot="18" class="slot-cell state-座">座</td><td data-slot="19" class="slot-cell state-座">座</td><td data-slot="20" class="slot-cell state-座">座</td></tr><tr data-place="外厩門 2" style="height: 43px;"><td data-slot="0" class="slot-cell state-準">準</td><td data-slot="1" class="slot-cell state-立">立</td><td data-slot="2" class="slot-cell state-座">座</td><td data-slot="3" class="slot-cell state-休">休</td><td data-slot="4" class="slot-cell state-立">立</td><td data-slot="5" class="slot-cell state-座">座</td><td data-slot="6" class="slot-cell state-立">立</td><td data-slot="7" class="slot-cell state-座">座</td><td data-slot="8" class="slot-cell state-立">立</td><td data-slot="9" class="slot-cell state-東">東</td><td data-slot="10" class="slot-cell state-東">東</td><td data-slot="11" class="slot-cell state-休">休</td><td data-slot="12" class="slot-cell state-座">座</td><td data-slot="13" class="slot-cell state-立">立</td><td data-slot="14" class="slot-cell state-休">休</td><td data-slot="15" class="slot-cell state-東">東</td><td data-slot="16" class="slot-cell state-東">東</td><td data-slot="17" class="slot-cell state-座">座</td><td data-slot="18" class="slot-cell state-座">座</td><td data-slot="19" class="slot-cell state-東">東</td><td data-slot="20" class="slot-cell state-東">東</td></tr><tr data-place="外厩門 3" style="height: 43px;"><td data-slot="0" class="slot-cell state-座">座</td><td data-slot="1" class="slot-cell state-待">待</td><td data-slot="2" class="slot-cell state-立">立</td><td data-slot="3" class="slot-cell state-座">座</td><td data-slot="4" class="slot-cell state-休">休</td><td data-slot="5" class="slot-cell state-立">立</td><td data-slot="6" class="slot-cell state-座">座</td><td data-slot="7" class="slot-cell state-立">立</td><td data-slot="8" class="slot-cell state-座">座</td><td data-slot="9" class="slot-cell state-立">立</td><td data-slot="10" class="slot-cell state-休">休</td><td data-slot="11" class="slot-cell state-東">東</td><td data-slot="12" class="slot-cell state-東">東</td><td data-slot="13" class="slot-cell state-休">休</td><td data-slot="14" class="slot-cell state-座">座</td><td data-slot="15" class="slot-cell state-立">立</td><td data-slot="16" class="slot-cell state-座">座</td><td data-slot="17" class="slot-cell state-東">東</td><td data-slot="18" class="slot-cell state-東">東</td><td data-slot="19" class="slot-cell state-座">座</td><td data-slot="20" class="slot-cell state-座">座</td></tr><tr data-place="外厩門 4" style="height: 43px;"><td data-slot="0" class="slot-cell empty"></td><td data-slot="1" class="slot-cell empty"></td><td data-slot="2" class="slot-cell empty"></td><td data-slot="3" class="slot-cell empty"></td><td data-slot="4" class="slot-cell empty"></td><td data-slot="5" class="slot-cell empty"></td><td data-slot="6" class="slot-cell empty"></td><td data-slot="7" class="slot-cell empty"></td><td data-slot="8" class="slot-cell state-休">休</td><td data-slot="9" class="slot-cell state-座">座</td><td data-slot="10" class="slot-cell state-立">立</td><td data-slot="11" class="slot-cell state-座">座</td><td data-slot="12" class="slot-cell state-立">立</td><td data-slot="13" class="slot-cell state-東">東</td><td data-slot="14" class="slot-cell state-東">東</td><td data-slot="15" class="slot-cell state-休">休</td><td data-slot="16" class="slot-cell empty"></td><td data-slot="17" class="slot-cell empty"></td><td data-slot="18" class="slot-cell empty"></td><td data-slot="19" class="slot-cell empty"></td><td data-slot="20" class="slot-cell empty"></td></tr><tr data-place="西通用門 4" style="height: 43px;"><td data-slot="0" class="slot-cell state-準">準</td><td data-slot="1" class="slot-cell state-立">立</td><td data-slot="2" class="slot-cell state-座">座</td><td data-slot="3" class="slot-cell state-休">休</td><td data-slot="4" class="slot-cell state-立">立</td><td data-slot="5" class="slot-cell state-座">座</td><td data-slot="6" class="slot-cell state-立">立</td><td data-slot="7" class="slot-cell state-座">座</td><td data-slot="8" class="slot-cell state-休">休</td><td data-slot="9" class="slot-cell empty"></td><td data-slot="10" class="slot-cell empty"></td><td data-slot="11" class="slot-cell empty"></td><td data-slot="12" class="slot-cell empty"></td><td data-slot="13" class="slot-cell empty"></td><td data-slot="14" class="slot-cell empty"></td><td data-slot="15" class="slot-cell state-休">休</td><td data-slot="16" class="slot-cell state-座">座</td><td data-slot="17" class="slot-cell state-座">座</td><td data-slot="18" class="slot-cell state-座">座</td><td data-slot="19" class="slot-cell state-座">座</td><td data-slot="20" class="slot-cell state-座">座</td></tr><tr data-place="西通用門 5" style="height: 43px;"><td data-slot="0" class="slot-cell state-立">立</td><td data-slot="1" class="slot-cell state-座">座</td><td data-slot="2" class="slot-cell state-立">立</td><td data-slot="3" class="slot-cell state-座">座</td><td data-slot="4" class="slot-cell state-待">待</td><td data-slot="5" class="slot-cell state-立">立</td><td data-slot="6" class="slot-cell state-座">座</td><td data-slot="7" class="slot-cell state-休">休</td><td data-slot="8" class="slot-cell state-立">立</td><td data-slot="9" class="slot-cell state-座">座</td><td data-slot="10" class="slot-cell state-立">立</td><td data-slot="11" class="slot-cell state-座">座</td><td data-slot="12" class="slot-cell state-座">座</td><td data-slot="13" class="slot-cell state-本">本</td><td data-slot="14" class="slot-cell state-立">立</td><td data-slot="15" class="slot-cell state-座">座</td><td data-slot="16" class="slot-cell empty"></td><td data-slot="17" class="slot-cell empty"></td><td data-slot="18" class="slot-cell empty"></td><td data-slot="19" class="slot-cell empty"></td><td data-slot="20" class="slot-cell empty"></td></tr><tr data-place="西通用門 6" style="height: 43px;"><td data-slot="0" class="slot-cell state-座">座</td><td data-slot="1" class="slot-cell state-待">待</td><td data-slot="2" class="slot-cell state-本">本</td><td data-slot="3" class="slot-cell state-立">立</td><td data-slot="4" class="slot-cell state-座">座</td><td data-slot="5" class="slot-cell state-休">休</td><td data-slot="6" class="slot-cell state-本">本</td><td data-slot="7" class="slot-cell state-立">立</td><td data-slot="8" class="slot-cell state-座">座</td><td data-slot="9" class="slot-cell state-立">立</td><td data-slot="10" class="slot-cell state-座">座</td><td data-slot="11" class="slot-cell state-立">立</td><td data-slot="12" class="slot-cell state-休">休</td><td data-slot="13" class="slot-cell state-座">座</td><td data-slot="14" class="slot-cell state-座">座</td><td data-slot="15" class="slot-cell state-立">立</td><td data-slot="16" class="slot-cell empty"></td><td data-slot="17" class="slot-cell empty"></td><td data-slot="18" class="slot-cell empty"></td><td data-slot="19" class="slot-cell empty"></td><td data-slot="20" class="slot-cell empty"></td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- 凡例 -->
    <div class="legend">
      <span><span class="legend-box state-本"></span>本</span>
      <span><span class="legend-box state-立"></span>立</span>
      <span><span class="legend-box state-座"></span>座</span>
      <span><span class="legend-box state-巡"></span>巡</span>
      <span><span class="legend-box state-東"></span>東</span>
      <span><span class="legend-box state-仮眠"></span>仮眠</span>
      <span><span class="legend-box state-休"></span>休</span>
      <span><span class="legend-box state-掃"></span>掃</span>
      <span><span class="legend-box state-待"></span>待</span>
      <span><span class="legend-box state-準"></span>準</span>
    </div>

    <!-- 名前入力パネル -->
    <div class="names-wrapper">
      <div class="names-panel" data-day="fri"></div>
      <div class="names-panel" data-day="sat"></div>
      <div class="names-panel" data-day="sun"></div>
    </div>

    <!-- 月間シフト（金・土・日） -->
    <div class="month-shift-editor">
      <div class="month-shift-header">
        月間シフト（金・土・日）
      </div>
      <div class="month-shift-controls">
        <label>対象月:
          <input type="month" id="monthPicker">
        </label>
        <button type="button" id="msAddPerson">＋ 人追加</button>
        <button type="button" id="msApplyToSchedule">保存</button>
      </div>
      <div class="month-shift-scroll">
        <table class="month-shift-table">
          <thead>
            <tr id="monthShiftHeadRow"></tr>
          </thead>
          <tbody id="monthShiftBody"></tbody>
        </table>
      </div>
      <div class="month-shift-hint">
        ※ 各セルで O / X / O1〜O7 / X1〜X7 / Y1〜Y7 を指定できます。O / X は厩舎長用です。
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore-compat.js"></script>

<script>
    (function(){
      // === Firebase / Firestore 設定 & LOCAL_STORE ===
      // ※ 必ず自分の Firebase プロジェクトの値に書き換えてください
const firebaseConfig = {
  apiKey: "AIzaSyCNUZdZeE9t6EFg9tDhSVF2qPcgiyPlrUs",
  authDomain: "cktaizai-c197d.firebaseapp.com",
  projectId: "cktaizai-c197d",
  storageBucket: "cktaizai-c197d.firebasestorage.app",
  messagingSenderId: "434618441616",
  appId: "1:434618441616:web:dd87d2d1f9385b697a9d15",
  measurementId: "G-1BZNEGWFZE"
};
      // Firestore 用のメモリ保存領域
      const __FS_MEMORY = {};
      let __fsInitialized = false;
      let __fsDocRef = null;

      if (typeof firebase !== "undefined" && firebase.apps && !firebase.apps.length) {
        try {
          firebase.initializeApp(firebaseConfig);
        } catch (e) {
          console.error("[Firebase] 初期化に失敗しました", e);
        }
      } else if (typeof firebase !== "undefined" && firebase.apps) {
        // すでに初期化済み
      }

      if (typeof firebase !== "undefined" && firebase.firestore) {
        const db = firebase.firestore();
        __fsDocRef = db.collection("standSchedules").doc("weekend");
        __fsDocRef.get().then((snap) => {
          if (snap.exists) {
            const data = snap.data();
            if (data && data.data && typeof data.data === "object") {
              Object.assign(__FS_MEMORY, data.data);
            }
          } else {
            // ドキュメントがない場合は空データで作成
            __fsDocRef.set({ data: {} }, { merge: true }).catch((e) => {
              console.error("[Firestore] 初期データ作成に失敗しました", e);
            });
          }
          __fsInitialized = true;
          console.log("[Firestore] 読み込み完了");

          // Firestore からの読み込みが完了したら localStorage 相当の読み込み処理をもう一度実行
          try {
            if (typeof loadCellsFromStorage === "function") {
              loadCellsFromStorage();
            }
            if (typeof syncAllPlaceHeaders === "function") {
              syncAllPlaceHeaders();
            }
            if (typeof normalizeTimeHeaders === "function") {
              normalizeTimeHeaders();
            }
            if (typeof syncAllRowHeights === "function") {
              syncAllRowHeights();
            }
          } catch (e) {
            console.error("[Firestore] 初期反映処理でエラー", e);
          }
        }).catch((e) => {
          console.error("[Firestore] 読み込みに失敗しました", e);
          __fsInitialized = true;
        });
      } else {
        console.warn("[Firebase] firebase.firestore が利用できません。LOCAL_STORE はメモリ上のみで動作します。");
      }

      function __pushFsMemory() {
        if (!__fsDocRef || !__fsInitialized) return;
        __fsDocRef.set({ data: __FS_MEMORY }, { merge: true }).catch((e) => {
          console.error("[Firestore] 書き込みに失敗しました", e);
        });
      }

      const LOCAL_STORE = {
        getItem(key) {
          return Object.prototype.hasOwnProperty.call(__FS_MEMORY, key) ? __FS_MEMORY[key] : null;
        },
        setItem(key, value) {
          __FS_MEMORY[key] = String(value);
          __pushFsMemory();
        },
        removeItem(key) {
          if (Object.prototype.hasOwnProperty.call(__FS_MEMORY, key)) {
            delete __FS_MEMORY[key];
            __pushFsMemory();
          }
        },
        clear() {
          for (const k of Object.keys(__FS_MEMORY)) {
            delete __FS_MEMORY[k];
          }
          __pushFsMemory();
        },
        key(n) {
          const keys = Object.keys(__FS_MEMORY);
          return keys[n] ?? null;
        },
        get length() {
          return Object.keys(__FS_MEMORY).length;
        }
      };

      const PLACES = [
        "厩舎長",
        "外厩門 1",
        "外厩門 2",
        "外厩門 3",
        "外厩門 4",
        "西通用門 4",
        "西通用門 5",
        "西通用門 6",
        "西通用門 7"
      ];
      const STATES = ["", "本", "立", "座", "巡", "東", "仮眠", "休", "掃", "待", "準", "ロ↑", "ロ↓"];

      const daySelect = document.getElementById("daySelect");
      const editToggle = document.getElementById("editToggle");
      const currentTimeEl = document.getElementById("currentTime");
      const monthPicker = document.getElementById("monthPicker");
      const msAddPerson = document.getElementById("msAddPerson");
      const msApplyButton = document.getElementById("msApplyToSchedule");
      const msHeadRow = document.getElementById("monthShiftHeadRow");
      const msBody = document.getElementById("monthShiftBody");

      // 金曜49、土日48
      const SLOT_COUNTS = {
        fri: 49,
        sat: 52,
        sun: 25
      };

      // 土曜日の初期データ（確定版）
      const INITIAL_DATA = {
  // =========================
  // 金曜日（0〜48：49コ）
  // =========================
  fri: {
    "厩舎長": [
      "本", "本", "待", "本", "本", "本", "本", "休", "休", "本", "本", "本", "本", "本", "本", "本", "本", "本",
      "本", "休", "休", "本", "本", "本", "本", "休", "本", "本", "本", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠",
      "仮眠", "仮眠", "本", "本", "本", "本", "本", "本", "本", "本", "本", "本", "本", "本"
      ],
    "外厩門 1": [
      "座", "立", "待", "東", "東", "休", "立", "座", "立", "東", "東", "休", "休", "座", "立", "休", "休", "東",
      "東", "座", "座", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "巡", "巡", "巡", "座", "座", "座",
      "巡", "巡", "巡", "座", "立", "座", "立", "座", "立", "座", "座", "立", "座", "掃"
      ],
    "外厩門 2": [
      "座", "座", "待", "立", "座", "東", "東", "休", "休", "座", "立", "座", "立", "東", "東", "座", "立", "座",
      "立", "休", "休", "座", "座", "休", "巡", "巡", "巡", "座", "座", "座", "座", "座", "巡", "巡", "巡", "座",
      "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "座", "立", "東", "東", "休", "立"
      ],
    "外厩門 3": [
      "立", "待", "立", "座", "立", "座", "休", "立", "座", "休", "休", "立", "座", "立", "座", "東", "東", "休",
      "休", "座", "座", "東", "東", "座", "座", "座", "座", "巡", "巡", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠",
      "仮眠", "仮眠", "座", "座", "座", "座", "立", "座", "東", "東", "立", "座", "立", "座"
      ],
    "外厩門 4": [
      "座", "待", "座", "休", "休", "立", "座", "東", "東", "立", "座", "東", "東", "休", "休", "立", "座", "座",
      "座", "東", "東", "巡", "巡", "巡", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "",
      "", "", "", "", "", "", "", "", ""
      ],
    "西通用門 4": [
      "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "",
      "", "座", "座", "座", "座", "休", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "座", "巡", "巡",
      "巡", "巡", "座", "立", "座", "立", "掃", "休", "座"
      ],
    "西通用門 5": [
      "立", "待", "座", "休", "休", "立", "座", "本", "本", "立", "座", "休", "立", "座", "立", "休", "休", "座",
      "座", "座", "座", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "座", "座", "座", "本", "本", "本",
      "巡", "巡", "巡", "座", "座", "座", "座", "立", "座", "立", "休", "座", "立", "掃"
      ],
    "西通用門 6": [
      "座", "立", "本", "立", "座", "休", "立", "座", "立", "座", "立", "座", "休", "休", "座", "立", "座", "休",
      "座", "座", "座", "巡", "巡", "巡", "休", "座", "座", "巡", "巡", "本", "本", "本", "巡", "巡", "巡", "座",
      "座", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "待", "休", "座", "立"
      ],
    "西通用門 7": [
      "座", "座", "立", "座", "立", "座", "待", "立", "座", "休", "休", "立", "座", "立", "待", "座", "立", "座",
      "休", "本", "本", "座", "座", "座", "巡", "巡", "巡", "休", "座", "巡", "巡", "巡", "座", "座", "座", "本",
      "本", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "座", "立", "休", "座"
      ]
  },

  // =========================
  // 土曜日（8:00〜翌10:00：52コ・0〜3は8:00〜9:30の空白）
  // =========================
  sat: {
    "厩舎長": [
      "", "", "", "", "本", "本", "休", "本", "本", "本", "本", "本", "休", "休", "本", "本", "本", "本", "休",
      "本", "本", "本", "休", "休", "本", "本", "本", "本", "休", "本", "本", "本", "仮眠", "仮眠", "仮眠", "仮眠",
      "仮眠", "仮眠", "仮眠", "仮眠", "本", "本", "本", "本", "本", "本", "本", "本", "本", "待", "本", "本"
      ],
    "外厩門 1": [
      "", "", "", "", "座", "休", "休", "座", "立", "休", "東", "東", "座", "立", "休", "休", "立", "座", "東",
      "東", "休", "休", "立", "座", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "巡", "巡", "巡", "座",
      "座", "座", "巡", "巡", "座", "座", "立", "座", "立", "座", "立", "座", "立", "座", "立", "掃"
      ],
    "外厩門 2": [
      "", "", "", "", "立", "座", "立", "待", "休", "休", "座", "立", "休", "休", "東", "東", "立", "座", "座",
      "立", "東", "東", "休", "休", "座", "座", "休", "座", "座", "座", "巡", "巡", "座", "座", "座", "巡", "巡",
      "巡", "座", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "座", "立", "東", "東", "座", "立"
      ],
    "外厩門 3": [
      "", "", "", "", "準", "立", "座", "立", "座", "立", "休", "休", "立", "座", "座", "休", "東", "東", "休",
      "休", "座", "立", "座", "立", "東", "東", "座", "巡", "巡", "巡", "休", "座", "仮眠", "仮眠", "仮眠", "仮眠",
      "仮眠", "仮眠", "仮眠", "座", "座", "座", "座", "立", "座", "立", "東", "東", "座", "立", "休", ""
      ],
    "外厩門 4": [
      "", "", "", "", "", "", "", "休", "休", "座", "立", "座", "東", "東", "立", "座", "休", "休", "立", "座",
      "立", "座", "東", "東", "巡", "巡", "巡", "巡", "巡", "巡", "座", "", "", "", "", "", "", "", "", "",
      "", "", "", "", "", "", "", "", "", "", "", ""
      ],
    "西通用門 4": [
      "", "", "", "", "準", "立", "座", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "",
      "", "", "", "", "", "座", "座", "座", "座", "休", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠",
      "座", "座", "座", "座", "座", "座", "座", "立", "座", "立", "休", "掃"
      ],
    "西通用門 5": [
      "", "", "", "", "準", "座", "休", "休", "立", "座", "立", "座", "立", "本", "休", "休", "立", "座", "立",
      "座", "休", "休", "本", "座", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "本", "本", "本", "巡",
      "巡", "巡", "座", "座", "座", "座", "巡", "巡", "巡", "巡", "巡", "座", "掃", "待", "立", "座"
      ],
    "西通用門 6": [
      "", "", "", "", "立", "待", "本", "立", "休", "休", "座", "立", "座", "座", "立", "座", "休", "休", "座",
      "立", "座", "立", "座", "立", "座", "座", "座", "休", "本", "座", "座", "座", "巡", "巡", "巡", "本", "本",
      "本", "巡", "巡", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "休", "本", "座", "立"
      ],
    "西通用門 7": [
      "", "", "", "", "座", "休", "立", "座", "座", "立", "休", "休", "本", "立", "座", "立", "座", "立", "休",
      "休", "立", "座", "立", "本", "巡", "巡", "巡", "座", "座", "休", "巡", "巡", "座", "座", "座", "座", "座",
      "座", "本", "本", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "仮眠", "立", "座", "待", "座"
      ]
  },

  // =========================
  // 日曜日（8:00〜20:00：25コ・0〜3は8:00〜9:30の空白）
  // =========================
  sun: {
    "厩舎長": [
      "", "", "", "", "本", "本", "待", "本", "本", "本", "休", "本", "本", "本", "本", "本", "本", "休", "本",
      "本", "本", "本", "本", "本", "本"
      ],
    "外厩門 1": [
      "", "", "", "", "立", "座", "待", "立", "座", "休", "東", "東", "東", "休", "座", "立", "休", "座", "立",
      "座", "座", "座", "座", "座", "座"
      ],
    "外厩門 2": [
      "", "", "", "", "準", "立", "座", "休", "立", "座", "立", "座", "立", "東", "東", "休", "座", "立", "休",
      "東", "東", "座", "座", "東", "東"
      ],
    "外厩門 3": [
      "", "", "", "", "座", "待", "立", "座", "休", "立", "座", "立", "座", "立", "休", "東", "東", "休", "座",
      "立", "座", "東", "東", "座", "座"
      ],
    "外厩門 4": [
      "", "", "", "", "", "", "", "", "", "", "", "", "休", "座", "立", "座", "立", "東", "東", "休", "",
      "", "", "", ""
      ],
    "西通用門 4": [
      "", "", "", "", "準", "立", "座", "休", "立", "座", "立", "座", "休", "", "", "", "", "", "", "休",
      "座", "座", "座", "座", "座"
      ],
    "西通用門 5": [
      "", "", "", "", "立", "座", "立", "座", "待", "立", "座", "休", "立", "座", "立", "座", "座", "本", "立",
      "座", "", "", "", "", ""
      ],
    "西通用門 6": [
      "", "", "", "", "座", "待", "本", "立", "座", "休", "本", "立", "座", "立", "座", "立", "休", "座", "座",
      "立", "", "", "", "", ""
      ]
  }
};

      // 前回のスロット
      let prevSlotIndex = null;

      function getSlotCountForDay(day) {
        const table = document.querySelector(`table.schedule-table[data-day="${day}"]`);
        if (!table) return SLOT_COUNTS[day] || 48;
        const headSlots = table.querySelectorAll("thead th[data-slot]").length;
        return headSlots || (SLOT_COUNTS[day] || 48);
      }

      // 場所テーブルのtbody生成
      function buildPlaceTableBodies() {
        ["fri","sat","sun"].forEach(day => {
          const table = document.querySelector(`table.place-table[data-day="${day}"]`);
          if (!table) return;
          const tbody = table.querySelector("tbody");
          tbody.innerHTML = "";
          PLACES.forEach(place => {
            if (day === "sun" && place === "西通用門 7") return;
            const tr = document.createElement("tr");
            tr.dataset.place = place;
            const th = document.createElement("th");
            th.className = "place-cell";
            th.textContent = place; // 後で名前を反映
            tr.appendChild(th);
            tbody.appendChild(tr);
          });
        });
      }

      // スケジュールテーブルのtbody生成
      function buildScheduleBodies() {
        ["fri","sat","sun"].forEach(day => {
          const table = document.querySelector(`table.schedule-table[data-day="${day}"]`);
          if (!table) return;
          const tbody = table.querySelector("tbody");
          tbody.innerHTML = "";
          const slotCount = getSlotCountForDay(day);
          const initForDay = (INITIAL_DATA[day] || {});

          PLACES.forEach(place => {
            if (day === "sun" && place === "西通用門 7") return;
            const tr = document.createElement("tr");
            tr.dataset.place = place;
            const rowInit = initForDay[place] || [];
            for (let i = 0; i < slotCount; i++) {
              const td = document.createElement("td");
              td.dataset.slot = String(i);
              td.className = "slot-cell empty";
              const v = rowInit[i] || "";
              if (v) {
                td.textContent = v;
                applyStateClass(td, v);
              }
              tr.appendChild(td);
            }
            tbody.appendChild(tr);
          });
        });
      }

      // 名前 → 表示文字列（厩舎長だけ1人分）
      
      function buildPlaceDisplay(day, place) {
        // まずはその日の通常の表示（今までどおり）
        let baseLabel;
        if (place === "厩舎長") {
          const key = `name_${day}_${place}_1`;
          const n = LOCAL_STORE.getItem(key) || "";
          baseLabel = n ? `${n}（${place}）` : place;
        } else {
          const key1 = `name_${day}_${place}_1`;
          const key2 = `name_${day}_${place}_2`;
          const n1 = LOCAL_STORE.getItem(key1) || "";
          const n2 = LOCAL_STORE.getItem(key2) || "";
          let namePart = "";
          if (n1 && n2) namePart = `${n1}・${n2}`;
          else if (n1) namePart = n1;
          else if (n2) namePart = n2;
          baseLabel = namePart ? `${namePart}（${place}）` : place;
        }

        // ★ 土曜日のロータリー情報を、土曜と金曜のラベルに反映させる
        //   rotary_sat_◯◯ というキーで「up / down」を保存している前提
        const rk = `rotary_sat_${place}`;
        const rv = LOCAL_STORE.getItem(rk) || "";
        if (rv === "up" || rv === "down") {
          // 土曜側の名前（ロータリー担当者）
          const s1 = LOCAL_STORE.getItem(`name_sat_${place}_1`) || "";
          const s2 = LOCAL_STORE.getItem(`name_sat_${place}_2`) || "";
          let satName = "";
          if (s1 && s2) satName = `${s1}・${s2}`;
          else if (s1) satName = s1;
          else if (s2) satName = s2;

          const tail = (rv === "up") ? "ロータリー↑ 8:00〜" : "ロータリー↓ 8:30〜";

          // 配置名のところにはロータリー情報を追記しない
          if (day === "sat") {
            // 土曜の表でも「◯◯（西通用門4）」のみ表示（「ロータリー↑ 8:00〜」などは表示しない）
          } else if (day === "fri") {
            // 金曜の表でも「土ロータリー: SatName ロータリー↑ 8:00〜」などは表示しない
          }
        }

        return baseLabel;
      }


      function syncPlaceHeaderForDay(day) {
        const table = document.querySelector(`table.place-table[data-day="${day}"]`);
        if (!table) return;
        table.querySelectorAll("tbody tr").forEach(tr => {
          const place = tr.dataset.place;
          if (!place) return;
          const th = tr.querySelector(".place-cell");
          if (!th) return;
          th.textContent = buildPlaceDisplay(day, place);
        });
      }

      function syncAllPlaceHeaders() {
        ["fri","sat","sun"].forEach(syncPlaceHeaderForDay);
      }

      function buildNamePanels() {
        const panels = document.querySelectorAll(".names-panel");
        panels.forEach(panel => {
          const day = panel.dataset.day;
          panel.innerHTML = "";
          PLACES.forEach(place => {
            const line = document.createElement("div");
            line.className = "name-line";
            line.dataset.place = place;

            const label = document.createElement("span");
            label.className = "name-line-label";
            label.textContent = place;
            line.appendChild(label);

            const isSingle = (place === "厩舎長");

            if (isSingle) {
              // 厩舎長だけ1人分
              const input = document.createElement("input");
              input.placeholder = "名前";
              const key = `name_${day}_${place}_1`;
              input.value = LOCAL_STORE.getItem(key) || "";
              input.addEventListener("input", () => {
                LOCAL_STORE.setItem(key, input.value);
                syncPlaceHeaderForDay(day);
                syncRowHeightsForDay(day);
              });
              line.appendChild(input);
            } else {
              // 通常2人分
              const input1 = document.createElement("input");
              input1.placeholder = "名前1";
              const input2 = document.createElement("input");
              input2.placeholder = "名前2";

              const key1 = `name_${day}_${place}_1`;
              const key2 = `name_${day}_${place}_2`;
              input1.value = LOCAL_STORE.getItem(key1) || "";
              input2.value = LOCAL_STORE.getItem(key2) || "";

              input1.addEventListener("input", () => {
                LOCAL_STORE.setItem(key1, input1.value);
                syncPlaceHeaderForDay(day);
                syncRowHeightsForDay(day);
              });
              input2.addEventListener("input", () => {
                LOCAL_STORE.setItem(key2, input2.value);
                syncPlaceHeaderForDay(day);
                syncRowHeightsForDay(day);
              });

              line.appendChild(input1);
              line.appendChild(input2);
            }

            panel.appendChild(line);
          });
        });
      }

      function applyStateClass(td, value) {
        td.className = td.className
          .replace(/state-[^\s]+/g, "")
          .replace(/\bempty\b/g,"")
          .trim();
        if (!value) {
          td.classList.add("slot-cell","empty");
        } else {
          td.classList.add("slot-cell","state-" + value);
        }
      }


      // ★ ロータリー関連ユーティリティ
      // 土日ともロータリー対象スロットは「その日の朝8:00〜」なので、
      // 実際にロ↑/ロ↓を書き込むのは、その日のテーブルの 8:00〜9:00（slot 0〜2）
      function getRotaryTarget(day) {
        if (day === "sat" || day === "sun") {
          // ロータリーは当日のテーブル(8:00〜10:00)に直接書き込む
          return { targetDay: day };
        }
        return { targetDay: day };
      }

      // バックアップ対象スロット（targetDay 側の index）
      function getRotaryBaseSlots(day) {
        if (day === "sat" || day === "sun") {
          // 土日テーブル: 0=8:00, 1=8:30, 2=9:00
          return [0, 1, 2];
        }
        return [];
      }

      // ロータリー種別ごとの対象スロットと表示文字
      function getRotarySetting(day, type) {
        if (day === "sat" || day === "sun") {
          if (type === "up") {
            // ロータリー（↑）: 8:00, 8:30
            return { slots: [0, 1], mark: "ロ↑" };
          }
          if (type === "down") {
            // ロータリー（↓）: 8:30, 9:00
            return { slots: [1, 2], mark: "ロ↓" };
          }
        }
        return { slots: [], mark: "" };
      }

      // 以前のロータリー状態を元に戻す
      function restoreOriginalCells(day, place) {
        const backupKey = `rotary_backup_${day}_${place}`;
        const raw = LOCAL_STORE.getItem(backupKey);
        if (!raw) return;

        let data;
        try {
          data = JSON.parse(raw);
        } catch {
          data = null;
        }
        if (!data) return;

        const target = getRotaryTarget(day);
        const table = document.querySelector(`table.schedule-table[data-day="${target.targetDay}"]`);
        if (!table) return;
        const tr = table.querySelector(`tbody tr[data-place="${place}"]`);
        if (!tr) return;

        Object.keys(data).forEach(slotStr => {
          const td = tr.querySelector(`td[data-slot="${slotStr}"]`);
          if (!td) return;
          const v = data[slotStr] || "";
          td.textContent = v;
          applyStateClass(td, v);
          const cellKey = `cell_${target.targetDay}_${place}_${slotStr}`;
          if (v) {
            LOCAL_STORE.setItem(cellKey, v);
          } else {
            LOCAL_STORE.removeItem(cellKey);
          }
        });

        LOCAL_STORE.removeItem(backupKey);
      }

      // ロータリーの選択を適用（up / down / 解除）
      function applyRotarySelection(day, place, value) {
        const baseSlots = getRotaryBaseSlots(day);
        if (!baseSlots.length) return;

        // まず前回のロータリーを元に戻す
        restoreOriginalCells(day, place);

        // 解除ならここで終了
        if (value !== "up" && value !== "down") {
          return;
        }

        const target = getRotaryTarget(day);
        const table = document.querySelector(`table.schedule-table[data-day="${target.targetDay}"]`);
        if (!table) return;
        const tr = table.querySelector(`tbody tr[data-place="${place}"]`);
        if (!tr) return;

        // 元の値をバックアップ（8:00 / 8:30 / 9:00 の3枠）
        const backup = {};
        baseSlots.forEach(slotIdx => {
          const td = tr.querySelector(`td[data-slot="${slotIdx}"]`);
          if (!td) return;
          backup[slotIdx] = td.textContent.trim();
        });
        LOCAL_STORE.setItem(`rotary_backup_${day}_${place}`, JSON.stringify(backup));

        // 新しいロータリー設定を反映
        const cfg = getRotarySetting(day, value);
        const slots = cfg.slots;
        const mark = cfg.mark;
        slots.forEach(slotIdx => {
          const td = tr.querySelector(`td[data-slot="${slotIdx}"]`);
          if (!td) return;
          td.textContent = mark;
          applyStateClass(td, mark);
          const cellKey = `cell_${target.targetDay}_${place}_${slotIdx}`;
          LOCAL_STORE.setItem(cellKey, mark);
        });
      }

      // ロータリー設定用の小さなメニューを開く（今回は土曜のみ）
      function openRotaryMenu(day, place, anchorEl) {
        // 既存メニューがあれば消す
        const old = document.getElementById("rotaryMenu");
        if (old && old.parentNode) {
          old.parentNode.removeChild(old);
        }

        const menu = document.createElement("div");
        menu.id = "rotaryMenu";
        menu.className = "rotary-menu";

        const title = document.createElement("div");
        title.className = "rotary-menu-title";
        let dayLabel = day;
        if (day === "sat") dayLabel = "土曜朝";
        else if (day === "sun") dayLabel = "日曜朝";
        title.textContent = `${place} のロータリー設定（${dayLabel}）`;
        menu.appendChild(title);

        const select = document.createElement("select");
        const optNone = document.createElement("option");
        optNone.value = "";
        optNone.textContent = "（ロータリーなし）";
        select.appendChild(optNone);

        const optUp = document.createElement("option");
        optUp.value = "up";
        optUp.textContent = "ロータリー（↑）8:00〜";
        select.appendChild(optUp);

        const optDown = document.createElement("option");
        optDown.value = "down";
        optDown.textContent = "ロータリー（↓）8:30〜";
        select.appendChild(optDown);

        const key = `rotary_${day}_${place}`;
        select.value = LOCAL_STORE.getItem(key) || "";

        menu.appendChild(select);
        document.body.appendChild(menu);

        // アンカーの右側あたりに表示
        const rect = anchorEl.getBoundingClientRect();
        menu.style.left = `${rect.right + 8}px`;
        menu.style.top = `${rect.top}px`;

        function closeMenu() {
          if (menu.parentNode) {
            menu.parentNode.removeChild(menu);
          }
        }

        select.addEventListener("change", () => {
          const value = select.value;
          applyRotarySelection(day, place, value);
          if (value) {
            LOCAL_STORE.setItem(key, value);
          } else {
            LOCAL_STORE.removeItem(key);
          }
          // ロータリー設定変更後に、各日のヘッダーを更新
          syncPlaceHeaderForDay("sat");
          syncPlaceHeaderForDay("fri");
          syncPlaceHeaderForDay("sun");
          syncAllRowHeights();
          closeMenu();
        });

        // 外側クリックで閉じる
        setTimeout(() => {
          const handler = (ev) => {
            if (!menu.contains(ev.target)) {
              document.removeEventListener("mousedown", handler);
              closeMenu();
            }
          };
          document.addEventListener("mousedown", handler);
        }, 0);
      }

      // 「配置＋名前」セルクリックでロータリーメニューを開く（土日共通）
      function setupRotaryClickHandlers() {
        ["sat","sun"].forEach(day => {
          const placeTable = document.querySelector(`table.place-table[data-day="${day}"]`);
          if (!placeTable) return;

          placeTable.addEventListener("click", (e) => {
            // 編集モード中のみ有効
            if (!document.body.classList.contains("month-editing")) return;

            const th = e.target.closest(".place-cell");
            if (!th) return;
            const tr = th.parentElement;
            const place = tr.dataset.place || "";
            if (!place) return;

            openRotaryMenu(day, place, th);
          });
        });
      }

      function saveCell(td) {
        const day = td.closest("table.schedule-table").dataset.day;
        const place = td.parentElement.dataset.place || "";
        const slot = td.dataset.slot || "";
        const key = `cell_${day}_${place}_${slot}`;
        const value = td.textContent.trim();
        LOCAL_STORE.setItem(key, value);
      }

      function loadCellsFromStorage() {
        document.querySelectorAll("table.schedule-table").forEach(table => {
          const day = table.dataset.day;
          table.querySelectorAll("tbody tr").forEach(tr => {
            const place = tr.dataset.place || "";
            tr.querySelectorAll("td[data-slot]").forEach(td => {
              const slot = td.dataset.slot || "";
              const key = `cell_${day}_${place}_${slot}`;
              const value = LOCAL_STORE.getItem(key);
              if (value !== null) {
                td.textContent = value;
                applyStateClass(td, value);
              }
            });
          });
        });
      }

      // ===== 配置テーブルとタイムテーブルの行高さを揃える =====
      function syncRowHeightsForDay(day){
        const placeTable  = document.querySelector(`table.place-table[data-day="${day}"]`);
        const schedTable  = document.querySelector(`table.schedule-table[data-day="${day}"]`);
        if (!placeTable || !schedTable) return;

        const placeRows = placeTable.querySelectorAll("tbody tr");
        const schedRows = schedTable.querySelectorAll("tbody tr");
        const len = Math.min(placeRows.length, schedRows.length);

        for (let i = 0; i < len; i++){
          const pr = placeRows[i];
          const sr = schedRows[i];

          // いったんリセットしてから測る
          pr.style.height = "";
          sr.style.height = "";

          const ph = pr.getBoundingClientRect().height;
          const sh = sr.getBoundingClientRect().height;
          const h  = Math.max(ph, sh);

          pr.style.height = h + "px";
          sr.style.height = h + "px";
        }
      }

      function syncAllRowHeights(){
        ["fri","sat","sun"].forEach(syncRowHeightsForDay);
      }

      // time-head の表示を 01:00 形式に統一
      function normalizeTimeHeaders(){
        document.querySelectorAll(".time-head").forEach(th => {
          const txt = th.textContent.trim();
          const m = txt.match(/^(\d{1,2}):(\d{2})$/);
          if (!m) return;
          let h = m[1];
          const mm = m[2];
          if (h.length === 1) h = "0" + h;
          th.textContent = `${h}:${mm}`;
        });
      }

      function handleCellClick(e){
        const td = e.currentTarget;
        if (!td.dataset.slot) return;
        if (td.querySelector("select")) return;

        const currentVal = td.textContent.trim();
        const select = document.createElement("select");

        const emptyOpt = document.createElement("option");
        emptyOpt.value = "";
        emptyOpt.textContent = "";
        select.appendChild(emptyOpt);

        STATES.slice(1).forEach(s => {
          const opt = document.createElement("option");
          opt.value = s;
          opt.textContent = s;
          select.appendChild(opt);
        });

        select.value = currentVal;
        td.textContent = "";
        td.appendChild(select);
        select.focus();

        function commit(){
          const v = select.value;
          td.removeChild(select);
          td.textContent = v;
          applyStateClass(td, v);
          saveCell(td);

          // セル編集後、その日の行高さを再同期
          const day = td.closest("table.schedule-table").dataset.day;
          syncRowHeightsForDay(day);
        }
        select.addEventListener("change", commit);
        select.addEventListener("blur", commit);
      }

      function attachCellHandlers() {
        // セルクリックによる直接編集は無効化（ハンドラを付けない）
        return;
      }

      // 現在時刻 → スロットindex
      function getCurrentSlotIndex(date, day) {
        const totalMin = date.getHours() * 60 + date.getMinutes();

        let startMin;
        if (day === "fri") {
          // 金曜は 9:30 スタート
          startMin = 9 * 60 + 30;
        } else if (day === "sat" || day === "sun") {
          // 土日はいずれも 8:00 スタート（ただし 8:00〜10:00 はロータリー用で初期データは空欄）
          startMin = 8 * 60;
        } else {
          startMin = 0;
        }

        const slotCount = getSlotCountForDay(day);

        let diff = totalMin - startMin;
        diff = (diff % (24 * 60) + (24 * 60)) % (24 * 60);

        let idx = Math.floor(diff / 30);
        if (idx < 0) idx = 0;
        if (idx > slotCount - 1) idx = slotCount - 1;
        return idx;
      }

      // 現在時刻の列を「配置」のすぐ右に持ってくる
      function scrollToNowColumn(smooth) {
        if (!daySelect) return;
        let activeDay = daySelect.value;
        // daySelectはYYYY-MM-DD（日付）なので、表示中の曜日キーに変換
        if (activeDay && activeDay.includes("-")) {
          const d = new Date(activeDay + "T00:00:00");
          if (!isNaN(d.getTime())) {
            const dow = d.getDay();
            if (dow === 5) activeDay = "fri";
            else if (dow === 6) activeDay = "sat";
            else if (dow === 0) activeDay = "sun";
          }
        }
        const wrapper = document.querySelector(`.day-wrapper[data-day="${activeDay}"]`);
        if (!wrapper) return;

        const container = wrapper.querySelector(".table-container");
        const table = wrapper.querySelector("table.schedule-table");
        if (!container || !table) return;

        // ヘッダー側に now-col が付いていればそちら優先
        const target =
          table.querySelector("thead th.now-col") ||
          table.querySelector("tbody td.now-col");
        if (!target) return;

        // スクロールコンテンツ内での left 位置
        const targetLeft = target.offsetLeft;

        // 配置のすぐ横に来るように、ほぼぴったり左端に合わせる
        const margin = 0; // 配置との間のちょっとした余白

        let desired = targetLeft - margin;
        if (desired < 0) desired = 0;

        const maxScroll = container.scrollWidth - container.clientWidth;
        if (desired > maxScroll) desired = maxScroll;

        container.scrollTo({
          left: desired,
          behavior: smooth ? "smooth" : "auto"
        });
      }


      function updateNowColumn(fromTimer) {
        const now = new Date();
        let activeDay = daySelect.value;
        // daySelectはYYYY-MM-DD（日付）を持っているので、曜日からfri/sat/sunを求める
        if (activeDay && activeDay.includes("-")) {
          const d = new Date(activeDay + "T00:00:00");
          if (!isNaN(d.getTime())) {
            const dow = d.getDay();
            if (dow === 5) activeDay = "fri";
            else if (dow === 6) activeDay = "sat";
            else if (dow === 0) activeDay = "sun";
          }
        }
        const idx = getCurrentSlotIndex(now, activeDay);

        const changed = (prevSlotIndex === null || prevSlotIndex !== idx);
        prevSlotIndex = idx;

        document.querySelectorAll("table.schedule-table").forEach(table => {
          const isActive = table.dataset.day === activeDay;
          table.querySelectorAll(".now-col").forEach(el => el.classList.remove("now-col"));
          if (!isActive) return;
          table.querySelectorAll(`[data-slot="${idx}"]`).forEach(el => {
            el.classList.add("now-col");
          });
        });

        const hh = String(now.getHours()).padStart(2,"0");
        const mm = String(now.getMinutes()).padStart(2,"0");
        currentTimeEl.textContent = `現在時刻 ${hh}:${mm}`;

        if (changed) {
          scrollToNowColumn(!!fromTimer);
        }
      }

      function setActiveDay(day) {
        document.querySelectorAll(".day-wrapper").forEach(w => {
          w.classList.toggle("active", w.dataset.day === day);
        });
        document.querySelectorAll(".names-panel").forEach(p => {
          p.classList.toggle("active", p.dataset.day === day);
        });
        prevSlotIndex = null;
        updateNowColumn(false);
        // 切り替えた日の行高さも同期
        syncRowHeightsForDay(day);
      }

      
      // ===== 月間シフト（金・土・日） =====
      function getActiveMonthStr() {
        if (!monthPicker) return "";
        let ym = monthPicker.value;
        if (!ym) {
          const now = new Date();
          const m = String(now.getMonth() + 1).padStart(2, "0");
          ym = `${now.getFullYear()}-${m}`;
          monthPicker.value = ym;
        }
        return ym;
      }

      function getFriSatSunDatesForActiveMonth() {
        const ym = getActiveMonthStr();
        if (!ym) return [];
        const [yStr, mStr] = ym.split("-");
        const y = parseInt(yStr, 10);
        const m = parseInt(mStr, 10) - 1;
        const dates = [];
        if (isNaN(y) || isNaN(m)) return dates;
        const d = new Date(y, m, 1);
        const wNames = ["日", "月", "火", "水", "木", "金", "土"];
        while (d.getMonth() === m) {
          const dow = d.getDay(); // 0:日,5:金,6:土
          if (dow === 5 || dow === 6 || dow === 0) {
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, "0");
            const dd = String(d.getDate()).padStart(2, "0");
            const dateStr = `${yyyy}-${mm}-${dd}`;
            const label = `${mm}/${dd}(${wNames[dow]})`;
            const dayKey = (dow === 5 ? "fri" : dow === 6 ? "sat" : "sun");
            dates.push({ dateStr, label, dayKey });
          }
          d.setDate(d.getDate() + 1);
        }
        return dates;
      }


      // 日付プルダウン(daySelect)を、対象月の金土日フル一覧に差し替える
      function rebuildDaySelectForActiveMonth() {
        if (!daySelect) return;
        const infos = getFriSatSunDatesForActiveMonth();
        daySelect.innerHTML = "";
        infos.forEach(info => {
          const opt = document.createElement("option");
          opt.value = info.dateStr; // YYYY-MM-DD
          opt.textContent = info.label; // 例: 12/05(金)
          daySelect.appendChild(opt);
        });
        if (!infos.length) return;

        // 今日が一覧に含まれていればその日を自動選択
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, "0");
        const dd = String(today.getDate()).padStart(2, "0");
        const todayStr = `${yyyy}-${mm}-${dd}`;
        const hasToday = infos.some(info => info.dateStr === todayStr);
        if (hasToday) {
          daySelect.value = todayStr;
        }

        applySelectedDateToSchedule();
      }

      // daySelectで選ばれている日付に応じて、表示するシフト(曜日)を切り替える
      function applySelectedDateToSchedule() {
        if (!daySelect || !daySelect.value) return;
        const dateStr = daySelect.value; // YYYY-MM-DD
        const d = new Date(dateStr + "T00:00:00");
        if (isNaN(d.getTime())) return;
        const dow = d.getDay(); // 0〜6
        const dayKey = (dow === 5 ? "fri" : dow === 6 ? "sat" : dow === 0 ? "sun" : null);
        if (!dayKey) return;
        setActiveDay(dayKey);
      }
      function loadMonthShiftData() {
        if (!monthPicker) return [];
        const ym = getActiveMonthStr();
        const key = `monthshift_${ym}`;
        try {
          const raw = LOCAL_STORE.getItem(key);
          if (!raw) return [];
          const parsed = JSON.parse(raw);
          if (!Array.isArray(parsed)) return [];
          return parsed;
        } catch (e) {
          console.warn("月間シフトの読み込みに失敗しました", e);
          return [];
        }
      }

      function saveMonthShiftTable() {
        if (!monthPicker || !msBody) return;
        const ym = getActiveMonthStr();
        const key = `monthshift_${ym}`;

        const rows = [];
        const dateInfos = getFriSatSunDatesForActiveMonth();
        const dateStrs = dateInfos.map(d => d.dateStr);

        msBody.querySelectorAll("tr").forEach(tr => {
          const nameInput = tr.querySelector("td.month-shift-name input");
          if (!nameInput) return;
          const name = nameInput.value.trim();
          const assignments = {};
          dateStrs.forEach((ds, idx) => {
            const sel = tr.querySelector(`td[data-col="${idx}"] select`);
            if (!sel) return;
            const v = sel.value;
            if (v) assignments[ds] = v;
          });
          if (!name && Object.keys(assignments).length === 0) return;
          rows.push({ name, assignments });
        });

        try {
          LOCAL_STORE.setItem(key, JSON.stringify(rows));
        } catch (e) {
          console.warn("月間シフトの保存に失敗しました", e);
        }
      }

      function appendMonthShiftRow(rowData, dateInfos) {
        if (!msBody) return;
        const tr = document.createElement("tr");

        const nameTd = document.createElement("td");
        nameTd.className = "month-shift-name";
        const nameInput = document.createElement("input");
        nameInput.type = "text";
        nameInput.value = rowData.name || "";
        nameTd.appendChild(nameInput);
        tr.appendChild(nameTd);

        dateInfos.forEach((info, idx) => {
          const td = document.createElement("td");
          td.dataset.col = String(idx);
          const sel = document.createElement("select");

          const addOpt = (val, label) => {
            const o = document.createElement("option");
            o.value = val;
            o.textContent = label;
            sel.appendChild(o);
          };

          addOpt("", "-");
          addOpt("O", "O（厩舎長 当直）");
          addOpt("X", "X（厩舎長 日勤）");
          ["O","X","Y"].forEach(prefix => {
            for (let i = 1; i <= 7; i++) {
              const code = `${prefix}${i}`;
              addOpt(code, code);
            }
          });

          const assigned = (rowData.assignments && rowData.assignments[info.dateStr]) || "";
          sel.value = assigned;

          sel.addEventListener("change", () => {
            saveMonthShiftTable();
          });

          td.appendChild(sel);
          tr.appendChild(td);
        });

        nameInput.addEventListener("input", () => {
          saveMonthShiftTable();
        });

        msBody.appendChild(tr);
      }

      function renderMonthShiftTable() {
        if (!msHeadRow || !msBody) return;
        const dateInfos = getFriSatSunDatesForActiveMonth();

        msHeadRow.innerHTML = "";
        const thName = document.createElement("th");
        thName.textContent = "氏名";
        msHeadRow.appendChild(thName);

        dateInfos.forEach(info => {
          const th = document.createElement("th");
          th.textContent = info.label;
          msHeadRow.appendChild(th);
        });

        msBody.innerHTML = "";

        const rows = loadMonthShiftData();
        if (!rows.length) {
          appendMonthShiftRow({ name: "", assignments: {} }, dateInfos);
        } else {
          rows.forEach(row => appendMonthShiftRow(row, dateInfos));
        }
      }
      // 旧バージョンで保存されていたセル編集データ(cell_*)は一度クリア（ロータリーは再設定前提）
      (function clearLegacyCellData(){
        const removeKeys = [];
        for (let i = 0; i < LOCAL_STORE.length; i++) {
          const key = LOCAL_STORE.key(i);
          if (key && key.startsWith("cell_")) {
            removeKeys.push(key);
          }
        }
        removeKeys.forEach(k => LOCAL_STORE.removeItem(k));
      })();

document.addEventListener("DOMContentLoaded", () => {
        buildPlaceTableBodies();
        buildScheduleBodies();
        buildNamePanels();
        attachCellHandlers();
        loadCellsFromStorage();
        syncAllPlaceHeaders();
        normalizeTimeHeaders();     // ★ 時刻表示を01:00形式にそろえる
        syncAllRowHeights();        // 全日の行高さを揃える
        setupRotaryClickHandlers(); // 土曜ロータリー（前日8:00〜）

        if (editToggle) {
          editToggle.addEventListener("change", () => {
            document.body.classList.toggle("month-editing", editToggle.checked);
          });
        }

        if (daySelect) {
          daySelect.addEventListener("change", () => {
            applySelectedDateToSchedule();
          });
        }

        // 月間シフト初期化
        if (monthPicker) {
          if (!monthPicker.value) {
            const now = new Date();
            const m = String(now.getMonth() + 1).padStart(2, "0");
            monthPicker.value = `${now.getFullYear()}-${m}`;
          }
          monthPicker.addEventListener("change", () => {
            renderMonthShiftTable();
            rebuildDaySelectForActiveMonth();
          });
        }
        if (msAddPerson) {
          msAddPerson.addEventListener("click", () => {
            const infos = getFriSatSunDatesForActiveMonth();
            appendMonthShiftRow({ name: "", assignments: {} }, infos);
            saveMonthShiftTable();
          });
        }
        if (msApplyButton) {
          msApplyButton.addEventListener("click", () => {
            saveMonthShiftTable();
            alert("月間シフトを保存しました。");
          });
        }
        renderMonthShiftTable();

        // 日付プルダウンを対象月の金土日で構成
        rebuildDaySelectForActiveMonth();

        // 初期表示（今日が金土日のいずれかなら自動でその日を選択）
        updateNowColumn(false);
        setInterval(() => updateNowColumn(true), 60000);

        // 画面サイズ変更時も行高さを再計算
        window.addEventListener("resize", () => {
          syncAllRowHeights();
        });
      });
    })();
  </script>
</body>
</html>
